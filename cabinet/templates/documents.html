<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–æ–∫—É–º–µ–Ω—Ç—ã ‚Äî Tender Sniper</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@700;900&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#0a0e17;--bg2:#111623;--bg3:#181e2e;--surface:rgba(255,255,255,0.04);--line:rgba(255,255,255,0.07);--gold:#d4a853;--gold-dim:rgba(212,168,83,0.12);--gold-line:rgba(212,168,83,0.25);--white:#f0f0f0;--gray:#6b7a90;--gray2:#99a8b8;--green:#3dd68c;--red:#e74c3c;--sidebar-w:240px}
    body{background:var(--bg);color:var(--white);font-family:'Manrope',system-ui,sans-serif;font-size:15px;line-height:1.55;display:flex;min-height:100vh}
    .sidebar{width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--line);padding:24px 16px;display:flex;flex-direction:column;position:fixed;height:100vh}
    .sidebar .logo{font-family:'Unbounded',sans-serif;font-size:16px;font-weight:900;margin-bottom:32px;padding:0 8px}.sidebar .logo span{color:var(--gold)}
    .sidebar nav{flex:1}
    .sidebar a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;color:var(--gray2);text-decoration:none;font-size:14px;font-weight:500;transition:all 0.15s;margin-bottom:2px}
    .sidebar a:hover{background:var(--surface);color:var(--white)}.sidebar a.active{background:var(--gold-dim);color:var(--gold)}
    .sidebar .icon{width:20px;text-align:center}
    .sidebar .bottom{border-top:1px solid var(--line);padding-top:16px;margin-top:auto}.sidebar .bottom a{color:var(--gray);font-size:13px}
    .main{margin-left:var(--sidebar-w);flex:1;padding:32px 40px}
    .page-header{margin-bottom:28px}.page-header h1{font-family:'Unbounded',sans-serif;font-size:22px;font-weight:700;margin-bottom:4px}.page-header p{color:var(--gray2);font-size:14px}
    .card{background:var(--bg2);border:1px solid var(--line);border-radius:12px;padding:24px;margin-bottom:16px}
    .tbl{width:100%;border-collapse:collapse}.tbl th{text-align:left;padding:10px 12px;font-size:12px;font-weight:600;color:var(--gray);text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--line)}.tbl td{padding:12px;border-bottom:1px solid var(--line);font-size:14px;vertical-align:middle}.tbl tr:hover td{background:var(--surface)}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-family:'Manrope',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all 0.15s;text-decoration:none}
    .btn-gold{background:var(--gold);color:#0a0e17}.btn-gold:hover{opacity:0.9}
    .btn-outline{background:transparent;border:1px solid var(--line);color:var(--white)}.btn-outline:hover{border-color:var(--gold-line);color:var(--gold)}
    .btn-sm{padding:6px 12px;font-size:12px}
    .badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600}
    .badge-green{background:rgba(61,214,140,0.15);color:var(--green)}.badge-gold{background:var(--gold-dim);color:var(--gold)}.badge-gray{background:var(--surface);color:var(--gray2)}.badge-red{background:rgba(231,76,60,0.15);color:var(--red)}
    .loading{text-align:center;padding:40px;color:var(--gray)}
    .spinner{width:32px;height:32px;border:3px solid var(--line);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 12px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:8px;background:var(--bg3);border:1px solid var(--gold-line);color:var(--white);font-size:14px;z-index:1000;opacity:0;transition:opacity 0.3s;pointer-events:none}.toast.show{opacity:1;pointer-events:auto}
    .doc-type{font-weight:600;font-size:13px}
    .empty{text-align:center;padding:48px;color:var(--gray)}
    .empty-icon{font-size:48px;margin-bottom:12px}
    @media(max-width:768px){.sidebar{width:0;overflow:hidden;padding:0}.main{margin-left:0;padding:16px}}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">TENDER<span>SNIPER</span></div>
    <nav>
      <a href="/cabinet/"><span class="icon">üìä</span> –¢–µ–Ω–¥–µ—Ä—ã</a>
      <a href="/cabinet/profile"><span class="icon">üè¢</span> –ü—Ä–æ—Ñ–∏–ª—å</a>
      <a href="/cabinet/documents" class="active"><span class="icon">üìÑ</span> –î–æ–∫—É–º–µ–Ω—Ç—ã</a>
      <a href="/cabinet/filters"><span class="icon">üéØ</span> –§–∏–ª—å—Ç—Ä—ã</a>
    </nav>
    <div class="bottom">
      <a href="https://t.me/TenderSniperBot">–ë–æ—Ç –≤ Telegram</a>
      <a href="/cabinet/logout">–í—ã–π—Ç–∏</a>
    </div>
  </aside>

  <main class="main">
    <div class="page-header">
      <h1>–î–æ–∫—É–º–µ–Ω—Ç—ã</h1>
      <p>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ç–µ–Ω–¥–µ—Ä–æ–≤</p>
    </div>

    <div class="card">
      <div class="loading" id="loading">
        <div class="spinner"></div>
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...
      </div>

      <div id="content" style="display:none"></div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    function showToast(msg,dur=3000){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),dur)}
    function fmtDate(d){if(!d)return'‚Äî';return new Date(d).toLocaleDateString('ru-RU')}

    const DOC_TYPE_NAMES = {
      'application': '–ó–∞—è–≤–∫–∞ –Ω–∞ —É—á–∞—Å—Ç–∏–µ',
      'declaration': '–î–µ–∫–ª–∞—Ä–∞—Ü–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è',
      'agreement': '–°–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏',
      'proposal': '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
    };

    const STATUS_BADGE = {
      'ready': '<span class="badge badge-green">–ì–æ—Ç–æ–≤</span>',
      'generating': '<span class="badge badge-gold">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>',
      'pending': '<span class="badge badge-gray">–û–∂–∏–¥–∞–Ω–∏–µ</span>',
      'error': '<span class="badge badge-red">–û—à–∏–±–∫–∞</span>',
    };

    async function loadDocuments() {
      const resp = await fetch('/cabinet/api/documents');
      if (resp.status === 401) { location.href = '/cabinet/login'; return; }
      const data = await resp.json();

      document.getElementById('loading').style.display = 'none';
      const content = document.getElementById('content');
      content.style.display = 'block';

      if (!data.documents || data.documents.length === 0) {
        content.innerHTML = '<div class="empty"><div class="empty-icon">üìÑ</div><p>–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p><p style="font-size:13px;margin-top:8px">–û—Ç–º–µ—Ç—å—Ç–µ —Ç–µ–Ω–¥–µ—Ä –∫–∞–∫ ¬´–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π¬ª –≤ –±–æ—Ç–µ ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p></div>';
        return;
      }

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ tender_number
      const grouped = {};
      data.documents.forEach(d => {
        if (!grouped[d.tender_number]) grouped[d.tender_number] = [];
        grouped[d.tender_number].push(d);
      });

      let html = '';
      for (const [tn, docs] of Object.entries(grouped)) {
        html += `<div style="margin-bottom:24px">`;
        html += `<h3 style="font-size:15px;margin-bottom:12px">–¢–µ–Ω–¥–µ—Ä ${tn}</h3>`;
        html += `<table class="tbl"><thead><tr><th>–î–æ–∫—É–º–µ–Ω—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞</th><th>–°–∫–∞—á–∞–Ω–æ</th><th></th></tr></thead><tbody>`;
        docs.forEach(d => {
          const name = DOC_TYPE_NAMES[d.doc_type] || d.doc_type;
          const status = STATUS_BADGE[d.generation_status] || d.generation_status;
          const downloadBtn = d.generation_status === 'ready'
            ? `<a href="/cabinet/api/documents/${d.id}/download" class="btn btn-sm btn-outline">‚¨á –°–∫–∞—á–∞—Ç—å</a>`
            : '';
          html += `<tr>
            <td class="doc-type">${name}</td>
            <td>${status}</td>
            <td>${fmtDate(d.created_at)}</td>
            <td>${d.downloaded_count}</td>
            <td>${downloadBtn}</td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      }

      content.innerHTML = html;
    }

    loadDocuments();
  </script>
</body>
</html>
