"""
–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Tender AI Bot.

–ü–æ—à–∞–≥–æ–≤–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ –≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –±–æ—Ç–∞ —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏.
"""

import logging
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

from tender_sniper.database import get_sniper_db

logger = logging.getLogger(__name__)
router = Router()


class OnboardingStates(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞."""
    welcome = State()
    features = State()
    demo_search = State()
    create_filter = State()
    notifications = State()
    completed = State()


# ============================================
# –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø –û–ù–ë–û–†–î–ò–ù–ì–ê
# ============================================

ONBOARDING_STEPS = {
    "welcome": {
        "emoji": "üëã",
        "title": "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
        "text": (
            "–ü—Ä–∏–≤–µ—Ç! –Ø **Tender AI Bot** ‚Äî –≤–∞—à —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ–Ω–¥–µ—Ä–æ–≤ –Ω–∞ zakupki.gov.ru.\n\n"
            "–Ø –ø–æ–º–æ–≥—É –≤–∞–º:\n"
            "‚Ä¢ üîç –ù–∞—Ö–æ–¥–∏—Ç—å —Ç–µ–Ω–¥–µ—Ä—ã –ø–æ –≤–∞—à–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º\n"
            "‚Ä¢ üéØ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥\n"
            "‚Ä¢ üìä –ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Ç–µ–Ω–¥–µ—Ä–∞—Ö\n"
            "‚Ä¢ ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–Ω–¥–µ—Ä—ã —Å –ø–æ–º–æ—â—å—é AI\n\n"
            "–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º –∫–æ—Ä–æ—Ç–∫—É—é —ç–∫—Å–∫—É—Ä—Å–∏—é (–∑–∞–π–º—ë—Ç 2-3 –º–∏–Ω—É—Ç—ã)!"
        ),
        "button": "üöÄ –ù–∞—á–∞—Ç—å —ç–∫—Å–∫—É—Ä—Å–∏—é"
    },
    "features": {
        "emoji": "‚ú®",
        "title": "–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
        "text": (
            "**üéØ Tender Sniper** ‚Äî –≥–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –±–æ—Ç–∞:\n\n"
            "**1. –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫** üîç\n"
            "–ë—ã—Å—Ç—Ä–æ –Ω–∞–π–¥–∏—Ç–µ —Ç–µ–Ω–¥–µ—Ä—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º, —Ä–µ–≥–∏–æ–Ω—É –∏ —Ü–µ–Ω–µ.\n\n"
            "**2. –£–º–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã** üé®\n"
            "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å —Ç–æ—á–Ω—ã–º–∏ –∫—Ä–∏—Ç–µ—Ä–∏—è–º–∏ –æ—Ç–±–æ—Ä–∞.\n\n"
            "**3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** ü§ñ\n"
            "–ë–æ—Ç —Å–∞–º –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å –Ω–æ–≤—ã–µ —Ç–µ–Ω–¥–µ—Ä—ã –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –∏ –ø—Ä–∏—Å—ã–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.\n\n"
            "**4. AI –∞–Ω–∞–ª–∏–∑** üß†\n"
            "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ (scoring —Å–∏—Å—Ç–µ–º–∞)."
        ),
        "button": "‚û°Ô∏è –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∏—Å–∫"
    },
    "demo_search": {
        "emoji": "üîç",
        "title": "–ü—Ä–æ–±–Ω—ã–π –ø–æ–∏—Å–∫",
        "text": (
            "–û—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ç–µ–Ω–¥–µ—Ä—ã.\n\n"
            "**–ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∏—â–µ–º:**\n"
            "‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: `–∫–æ–º–ø—å—é—Ç–µ—Ä—ã`\n"
            "‚Ä¢ –†–µ–≥–∏–æ–Ω: `–ú–æ—Å–∫–≤–∞`\n"
            "‚Ä¢ –¶–µ–Ω–∞: `1 000 000 - 5 000 000 ‚ÇΩ`\n\n"
            "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å **–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫**."
        ),
        "button": "üîé –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫"
    },
    "create_filter": {
        "emoji": "üé®",
        "title": "–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞",
        "text": (
            "–¢–µ–ø–µ—Ä—å –æ —Ñ–∏–ª—å—Ç—Ä–∞—Ö!\n\n"
            "**–§–∏–ª—å—Ç—Ä—ã** ‚Äî —ç—Ç–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∏—Å–∫–∞, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ—Ç —Ç–µ–Ω–¥–µ—Ä—ã.\n\n"
            "**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**\n"
            "1. –í—ã —Å–æ–∑–¥–∞—ë—Ç–µ —Ñ–∏–ª—å—Ç—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, \"IT –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –ú–æ—Å–∫–≤—ã\")\n"
            "2. –£–∫–∞–∑—ã–≤–∞–µ—Ç–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ (–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —Ä–µ–≥–∏–æ–Ω, —Ü–µ–Ω–∞)\n"
            "3. –ë–æ—Ç –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –∏—â–µ—Ç –Ω–æ–≤—ã–µ —Ç–µ–Ω–¥–µ—Ä—ã\n"
            "4. –ï—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç ‚Äî –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –≤–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!\n\n"
            "–ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ñ–∏–ª—å—Ç—Ä?"
        ),
        "button": "‚ûï –°–æ–∑–¥–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä"
    },
    "notifications": {
        "emoji": "üîî",
        "title": "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
        "text": (
            "–û—Ç–ª–∏—á–Ω–æ! –í—ã –ø–æ—á—Ç–∏ –æ—Å–≤–æ–∏–ª–∏—Å—å.\n\n"
            "**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**\n\n"
            "ü§ñ –ê–≤—Ç–æ–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ\n"
            "üì© –ù–æ–≤—ã–µ —Ç–µ–Ω–¥–µ—Ä—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –ø—Ä—è–º–æ –≤ —á–∞—Ç\n"
            "‚≠ê Scoring —Å–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å (0-100)\n"
            "üìä –ü–æ–ª–Ω—ã–µ –æ—Ç—á—ë—Ç—ã –≤ HTML —Ñ–æ—Ä–º–∞—Ç–µ\n\n"
            "**–í–∞–∂–Ω–æ:**\n"
            "‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω: 5 —Ñ–∏–ª—å—Ç—Ä–æ–≤, 15 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π/–¥–µ–Ω—å\n"
            "‚Ä¢ Basic: 15 —Ñ–∏–ª—å—Ç—Ä–æ–≤, 50 —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π/–¥–µ–Ω—å\n"
            "‚Ä¢ Premium: –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π\n\n"
            "–í—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ **–ú–æ–∏ —Ñ–∏–ª—å—Ç—Ä—ã**."
        ),
        "button": "‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —ç–∫—Å–∫—É—Ä—Å–∏—é"
    },
    "completed": {
        "emoji": "üéâ",
        "title": "–ì–æ—Ç–æ–≤–æ!",
        "text": (
            "–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –í—ã –ø—Ä–æ—à–ª–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥.\n\n"
            "**–ß—Ç–æ –¥–∞–ª—å—à–µ?**\n\n"
            "1Ô∏è‚É£ –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Ñ–∏–ª—å—Ç—Ä\n"
            "2Ô∏è‚É£ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫\n"
            "3Ô∏è‚É£ –ò–∑—É—á–∏—Ç–µ –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–µ–Ω–¥–µ—Ä—ã\n\n"
            "**–ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n"
            "‚Ä¢ /sniper ‚Äî –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é Tender Sniper\n"
            "‚Ä¢ /start ‚Äî –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞\n"
            "‚Ä¢ /help ‚Äî —Å–ø—Ä–∞–≤–∫–∞\n\n"
            "–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –≤–æ–ø—Ä–æ—Å—ã ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å! üòä\n\n"
            "–£–¥–∞—á–∏ –≤ –ø–æ–∏—Å–∫–∞—Ö! üöÄ"
        ),
        "button": "üéØ –ü–µ—Ä–µ–π—Ç–∏ –≤ Tender Sniper"
    }
}


async def is_first_time_user(user_id: int) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞, –≤–ø–µ—Ä–≤—ã–µ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞.

    Args:
        user_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Returns:
        True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π
    """
    try:
        db = await get_sniper_db()
        user = await db.get_user_by_telegram_id(user_id)

        if not user:
            return True

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Ö–æ–¥–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
        # (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ onboarding_completed –≤ –ë–î)
        # –ü–æ–∫–∞ —Å—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã–º, –µ—Å–ª–∏ —É –Ω–µ–≥–æ –Ω–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤
        filters = await db.get_user_filters(user['id'])
        return len(filters) == 0

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞: {e}")
        return False


def get_onboarding_keyboard(step: str) -> InlineKeyboardMarkup:
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —à–∞–≥–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞.

    Args:
        step: –ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞

    Returns:
        –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    """
    step_data = ONBOARDING_STEPS.get(step, ONBOARDING_STEPS["welcome"])

    keyboard = [
        [InlineKeyboardButton(
            text=step_data["button"],
            callback_data=f"onboarding_next_{step}"
        )]
    ]

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" –¥–ª—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
    if step not in ["welcome", "completed"]:
        keyboard.append([
            InlineKeyboardButton(
                text="‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å–∫—É—Ä—Å–∏—é",
                callback_data="onboarding_skip"
            )
        ])

    return InlineKeyboardMarkup(inline_keyboard=keyboard)


async def show_onboarding_step(
    message_or_query: Message | CallbackQuery,
    step: str,
    state: FSMContext
):
    """
    –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∞–≥–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞.

    Args:
        message_or_query: –°–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ callback query
        step: –ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞
        state: FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç
    """
    step_data = ONBOARDING_STEPS.get(step, ONBOARDING_STEPS["welcome"])

    text = f"{step_data['emoji']} **{step_data['title']}**\n\n{step_data['text']}"
    keyboard = get_onboarding_keyboard(step)

    try:
        if isinstance(message_or_query, Message):
            await message_or_query.answer(text, reply_markup=keyboard, parse_mode="Markdown")
        else:
            await message_or_query.message.edit_text(text, reply_markup=keyboard, parse_mode="Markdown")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞: {e}")


# ============================================
# HANDLERS
# ============================================

@router.callback_query(F.data.startswith("onboarding_next_"))
async def process_onboarding_step(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞."""
    current_step = callback.data.replace("onboarding_next_", "")

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
    steps_order = ["welcome", "features", "demo_search", "create_filter", "notifications", "completed"]

    try:
        current_index = steps_order.index(current_step)
        next_step = steps_order[current_index + 1] if current_index + 1 < len(steps_order) else "completed"
    except (ValueError, IndexError):
        next_step = "welcome"

    # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —à–∞–≥–æ–≤
    if current_step == "demo_search":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫
        await callback.answer("üîç –û—Ç–∫—Ä—ã–≤–∞—é –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫...")
        await callback.message.answer(
            "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ /sniper –∏ –≤—ã–±–µ—Ä–∏—Ç–µ **üîç –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫**.\n\n"
            "–ü–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —ç–∫—Å–∫—É—Ä—Å–∏—é."
        )
        # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
        next_step = "create_filter"

    elif current_step == "create_filter":
        # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
        await callback.answer("‚ûï –û—Ç–∫—Ä—ã–≤–∞—é —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞...")
        await callback.message.answer(
            "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ /sniper ‚Üí **–ú–æ–∏ —Ñ–∏–ª—å—Ç—Ä—ã** ‚Üí **‚ûï –ù–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä**.\n\n"
            "–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å —Å—é–¥–∞."
        )

    elif current_step == "completed":
        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
        await callback.answer("‚úÖ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω!")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—à—ë–ª –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
        try:
            db = await get_sniper_db()
            user = await db.get_user_by_telegram_id(callback.from_user.id)
            if user:
                # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ onboarding_completed –≤ –ë–î
                pass
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞: {e}")

        # –û—Ç–∫—Ä—ã–≤–∞–µ–º Tender Sniper
        from bot.handlers.sniper import show_sniper_menu
        await show_sniper_menu(callback.message, state)
        return

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥
    await show_onboarding_step(callback, next_step, state)
    await callback.answer()


@router.callback_query(F.data == "onboarding_skip")
async def skip_onboarding(callback: CallbackQuery, state: FSMContext):
    """–ü—Ä–æ–ø—É—Å–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞."""
    await callback.answer("–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø—Ä–æ–ø—É—â–µ–Ω")

    await callback.message.edit_text(
        "‚è≠Ô∏è –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø—Ä–æ–ø—É—â–µ–Ω.\n\n"
        "–í—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —ç–∫—Å–∫—É—Ä—Å–∏—é –∑–∞–Ω–æ–≤–æ –∫–æ–º–∞–Ω–¥–æ–π:\n"
        "/start onboarding\n\n"
        "–ü–µ—Ä–µ—Ö–æ–∂—É –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é..."
    )

    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    from bot.handlers.start import cmd_start
    await cmd_start(callback.message, state)


async def start_onboarding(message: Message, state: FSMContext):
    """
    –ó–∞–ø—É—Å–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        state: FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç
    """
    logger.info(f"–ó–∞–ø—É—Å–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")

    await state.set_state(OnboardingStates.welcome)
    await show_onboarding_step(message, "welcome", state)


# ============================================
# –≠–ö–°–ü–û–†–¢
# ============================================

__all__ = [
    "router",
    "start_onboarding",
    "is_first_time_user"
]
