"""
Библиотека промптов для Chain-of-Thought извлечения и верификации
Каждый промпт оптимизирован под конкретный параметр
"""

# ============= EXTRACTION PROMPTS (Chain-of-Thought) =============

EXTRACT_NMCK_PROMPT = """Ты — эксперт по извлечению финансовых параметров из тендерной документации.
Твоя специализация — точное определение НМЦК (начальной максимальной цены контракта).

ДОКУМЕНТАЦИЯ:
{document}

ЗАДАЧА: Найти и извлечь НМЦК с полным обоснованием

РАБОТАЙ ПОШАГОВО (Chain-of-Thought):

Шаг 1: ГДЕ ИСКАТЬ НМЦК?
- Проанализируй структуру документа
- Определи разделы, где обычно указывается цена:
  * Извещение о закупке (раздел "Цена контракта")
  * Проект контракта (раздел "Цена")
  * Техническое задание (итоговая таблица)
  * Спецификация (сумма позиций)
- Перечисли ВСЕ найденные разделы с ценой

Шаг 2: НАЙДИ ВСЕ УПОМИНАНИЯ ЦЕНЫ
- Просмотри каждый найденный раздел
- Выпиши ВСЕ числовые значения, которые могут быть ценой
- Укажи для каждого: значение, источник, контекст

Шаг 3: ПРОВЕРЬ НА ПРОТИВОРЕЧИЯ
- Совпадают ли цены в разных разделах?
- Если НЕТ — опиши противоречие детально
- Если ДА — подтверди согласованность

Шаг 4: ОПРЕДЕЛИ ВАЛЮТУ И НДС
- В какой валюте указана цена? (рубли/доллары/евро)
- Включен ли НДС?
- Если НДС включен — это должно быть явно указано
- Если не указано — напиши "НЕ УКАЗАНО"

Шаг 5: ОПРЕДЕЛИ ОКОНЧАТЕЛЬНУЮ НМЦК
- На основе анализа шагов 1-4
- Если есть противоречия — выбери наиболее авторитетный источник
- Обоснуй свой выбор

ФОРМАТ ОТВЕТА (строгий JSON):
{{
  "reasoning": {{
    "step1": {{
      "description": "Какие разделы проверил",
      "found_sections": ["Раздел 1", "Раздел 2", ...]
    }},
    "step2": {{
      "description": "Все найденные упоминания цены",
      "findings": [
        {{"value": 5000000, "source": "Раздел 3.1", "context": "Цена контракта"}},
        ...
      ]
    }},
    "step3": {{
      "description": "Анализ на противоречия",
      "contradictions_found": true/false,
      "details": "Описание"
    }},
    "step4": {{
      "description": "Валюта и НДС",
      "currency": "RUB/USD/EUR",
      "vat_status": "Включен/Не включен/Не указано"
    }},
    "step5": {{
      "description": "Итоговый вывод с обоснованием",
      "analysis": "Почему выбрано именно это значение"
    }}
  }},
  "result": {{
    "value": 5000000.00,
    "currency": "RUB",
    "vat_included": true,
    "source": "Извещение о закупке, раздел 3.1",
    "confidence": "HIGH"
  }}
}}

ВАЖНО:
- Будь максимально точным
- Не придумывай данные — только то, что есть в документе
- Если что-то неясно — укажи confidence: "MEDIUM" или "LOW"
- Прямо цитируй документ в reasoning"""


EXTRACT_DEADLINE_PROMPT = """Ты — эксперт по извлечению сроков из тендерной документации.

ДОКУМЕНТАЦИЯ:
{document}

ЗАДАЧА: Найти срок {deadline_type}

РАБОТАЙ ПОШАГОВО:

Шаг 1: ГДЕ ИСКАТЬ СРОК?
- Определи релевантные разделы документа
- Для подачи заявок: обычно в извещении, разделе "Порядок подачи"
- Для исполнения: в проекте контракта, разделе "Срок выполнения"

Шаг 2: НАЙДИ ВСЕ УПОМИНАНИЯ ДАТЫ
- Выпиши ВСЕ найденные даты
- Укажи формат каждой даты
- Укажи источник

Шаг 3: ОПРЕДЕЛИ ТОЧНУЮ ДАТУ И ВРЕМЯ
- Если указано только число — найди месяц и год
- Если указано время — зафиксируй его
- Если НЕ указано время — напиши "НЕ УКАЗАНО"

Шаг 4: ОПРЕДЕЛИ ЧАСОВОЙ ПОЯС
- Московское время (МСК/UTC+3)?
- Местное время?
- Если не указан — предположи МСК (стандарт для РФ)

Шаг 5: ПРОВЕРЬ НА ПРОТИВОРЕЧИЯ
- Есть ли другие упоминания этого же срока?
- Совпадают ли они?

ФОРМАТ ОТВЕТА (строгий JSON):
{{
  "reasoning": {{
    "step1": {{"found_sections": [...]}},
    "step2": {{"all_dates_found": [...]}},
    "step3": {{"exact_datetime": "...", "format": "..."}},
    "step4": {{"timezone_analysis": "..."}},
    "step5": {{"contradictions": "..."}}
  }},
  "result": {{
    "datetime_str": "2024-03-15T10:00:00+03:00",
    "timezone": "MSK",
    "description": "{deadline_type}",
    "source": "Раздел X",
    "confidence": "HIGH"
  }}
}}"""


EXTRACT_GUARANTEE_PROMPT = """Ты — эксперт по извлечению информации об обеспечениях из тендеров.

ДОКУМЕНТАЦИЯ:
{document}

ЗАДАЧА: Найти обеспечение {guarantee_type}

РАБОТАЙ ПОШАГОВО:

Шаг 1: ГДЕ ИСКАТЬ?
- Для обеспечения заявки: раздел "Требования к участникам"
- Для обеспечения контракта: проект контракта

Шаг 2: НАЙДИ ИНФОРМАЦИЮ ОБ ОБЕСПЕЧЕНИИ
- Ищи фразы: "обеспечение заявки", "обеспечение контракта", "банковская гарантия"
- Выпиши ВСЕ найденные упоминания

Шаг 3: ОПРЕДЕЛИ РАЗМЕР
- Указана ли точная сумма?
- Или процент от НМЦК?
- Если процент — какой?
- Если сумма — какая?

Шаг 4: ПРОВЕРЬ РАСЧЕТ
- Если указан процент — можешь ли рассчитать сумму?
- Если указана сумма — соответствует ли она проценту от известной НМЦК?

Шаг 5: ИТОГОВОЕ ОБЕСПЕЧЕНИЕ
- Что требуется?
- В каком размере?

ФОРМАТ ОТВЕТА:
{{
  "reasoning": {{
    "step1": {{"sections": [...]}},
    "step2": {{"findings": [...]}},
    "step3": {{"size_analysis": "..."}},
    "step4": {{"calculation_check": "..."}},
    "step5": {{"conclusion": "..."}}
  }},
  "result": {{
    "amount": 250000.00,
    "percentage": 5.0,
    "type": "{guarantee_type}",
    "source": "...",
    "confidence": "HIGH"
  }}
}}"""


EXTRACT_REQUIREMENTS_PROMPT = """Ты — эксперт по извлечению требований к участникам тендера.

ДОКУМЕНТАЦИЯ:
{document}

ЗАДАЧА: Найти ВСЕ требования к участникам (технические, квалификационные, финансовые)

РАБОТАЙ ПОШАГОВО:

Шаг 1: ОПРЕДЕЛИ РАЗДЕЛЫ С ТРЕБОВАНИЯМИ
- Техническое задание
- Инструкция участникам
- Раздел "Требования к участникам"

Шаг 2: КАТЕГОРИЗИРУЙ ТРЕБОВАНИЯ
Для каждого требования определи категорию:
- Сертификация (ISO, ГОСТ, СРО)
- Опыт (количество лет, выполненные контракты)
- Лицензии
- Персонал (количество, квалификация)
- Финансовые (оборот, капитал)
- Технические (оборудование, склады)

Шаг 3: ОПРЕДЕЛИ ОБЯЗАТЕЛЬНОСТЬ
- Обязательные требования (ДОЛЖЕН, ТРЕБУЕТСЯ)
- Желательные требования (ЖЕЛАТЕЛЬНО, РЕКОМЕНДУЕТСЯ)

Шаг 4: ИЗВЛЕКИ ДЕТАЛИ
- Для опыта: сколько лет, какого рода контракты
- Для сертификатов: какие именно
- Для финансов: суммы, показатели

Шаг 5: СОСТАВЬ ПОЛНЫЙ СПИСОК

ФОРМАТ ОТВЕТА:
{{
  "reasoning": {{
    "step1": {{"sections_found": [...]}},
    "step2": {{"categorization": "..."}},
    "step3": {{"mandatory_vs_optional": "..."}},
    "step4": {{"details_extracted": "..."}},
    "step5": {{"total_count": X}}
  }},
  "result": {{
    "requirements": [
      {{
        "requirement": "ISO 9001",
        "category": "Сертификация",
        "is_mandatory": true,
        "source": "ТЗ, раздел 2.3"
      }},
      ...
    ],
    "confidence": "HIGH"
  }}
}}"""


# ============= VERIFICATION PROMPTS =============

VERIFICATION_PROMPT = """Ты — критически настроенный ИНСПЕКТОР по проверке извлеченных данных.
Твоя задача — НЕ соглашаться автоматически, а ПРОВЕРЯТЬ каждое утверждение.

ИЗВЛЕЧЕННАЯ ИНФОРМАЦИЯ:
{extracted_data}

ОРИГИНАЛЬНЫЙ ДОКУМЕНТ:
{document}

ПАРАМЕТР ДЛЯ ПРОВЕРКИ: {parameter_name}

ЗАДАЧА: Проверь правильность извлеченной информации

РАБОТАЙ КАК СЛЕДОВАТЕЛЬ:

1. ПРОВЕРКА ИСТОЧНИКА:
   - Найди ТОЧНУЮ цитату из документа, подтверждающую извлеченное значение
   - Скопируй эту цитату дословно
   - Укажи раздел/страницу
   - Если цитату найти не удается — это КРИТИЧЕСКАЯ ошибка

2. ПРОВЕРКА НА ПРОТИВОРЕЧИЯ:
   - Ищи ВСЕ другие упоминания этого параметра в документе
   - Сравни их с извлеченным значением
   - Если есть расхождения — опиши ДЕТАЛЬНО
   - Если нашел противоречие — укажи, какое значение правильное

3. ПРОВЕРКА ЛОГИЧНОСТИ:
   - Логично ли это значение?
   - Примеры нелогичных значений:
     * НМЦК = 1 руб (слишком мало)
     * НМЦК = 999 млрд (слишком много)
     * Срок подачи заявок в прошлом
     * Обеспечение = 150% от НМЦК (слишком много)
   - Если нелогично — опиши почему

4. ПРОВЕРКА ПОЛНОТЫ:
   - Извлечена ли вся необходимая информация?
   - Для НМЦК: валюта, НДС, источник?
   - Для сроков: дата, время, часовой пояс?
   - Если что-то отсутствует — укажи

5. ИТОГОВОЕ РЕШЕНИЕ:
   - CONFIRMED: всё правильно, данные подтверждены
   - CORRECTED: найдена ошибка, вот правильное значение
   - REJECTED: данные полностью неверны
   - NEEDS_REVIEW: есть сомнения, требуется ручная проверка

ФОРМАТ ОТВЕТА:
{{
  "status": "CONFIRMED/CORRECTED/REJECTED/NEEDS_REVIEW",
  "evidence": [
    {{
      "quote": "Прямая цитата из документа",
      "source": "Раздел X, страница Y",
      "page_number": Y
    }}
  ],
  "contradictions": [
    {{
      "description": "Описание противоречия",
      "value1": "Извлеченное значение",
      "source1": "Источник 1",
      "value2": "Другое значение в документе",
      "source2": "Источник 2",
      "severity": "CRITICAL/MAJOR/MINOR"
    }}
  ],
  "corrected_value": null,
  "confidence": "HIGH/MEDIUM/LOW",
  "issues": ["Если есть проблемы"],
  "reasoning": "Подробное объяснение твоего решения"
}}

КРИТИЧЕСКИ ВАЖНО:
- НЕ соглашайся автоматически
- Ищи противоречия активно
- Требуй ПРЯМЫХ ЦИТАТ
- Если сомневаешься — ставь NEEDS_REVIEW
- Будь придирчивым"""


# ============= HELPER FUNCTIONS =============

def format_extraction_prompt(
    template: str,
    document: str,
    **kwargs
) -> str:
    """
    Форматирует промпт для извлечения
    
    Args:
        template: Шаблон промпта
        document: Текст документа
        **kwargs: Дополнительные параметры
    
    Returns:
        Отформатированный промпт
    """
    return template.format(document=document, **kwargs)


def format_verification_prompt(
    extracted_data: dict,
    document: str,
    parameter_name: str
) -> str:
    """
    Форматирует промпт для верификации
    
    Args:
        extracted_data: Извлеченные данные
        document: Текст документа
        parameter_name: Название параметра
    
    Returns:
        Отформатированный промпт
    """
    import json
    
    extracted_json = json.dumps(extracted_data, indent=2, ensure_ascii=False)
    
    return VERIFICATION_PROMPT.format(
        extracted_data=extracted_json,
        document=document,
        parameter_name=parameter_name
    )
