"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–º–æ—â—å—é LLM.
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ–Ω–¥–µ—Ä–æ–≤.
"""

from typing import List, Dict, Any
import json
import sys
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from utils.transliterator import Transliterator
except ImportError:
    # Fallback –µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
    class Transliterator:
        @classmethod
        def has_latin(cls, text):
            import re
            return bool(re.search(r'[a-zA-Z]', text))

        @classmethod
        def transliterate(cls, text):
            return text

        @classmethod
        def generate_variants(cls, text):
            return [text]


class SmartSearchExpander:
    """–†–∞—Å—à–∏—Ä—è–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–æ–≥–æ –æ—Ö–≤–∞—Ç–∞."""

    def __init__(self, llm_adapter):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–∏—Ç–µ–ª—è –ø–æ–∏—Å–∫–∞.

        Args:
            llm_adapter: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LLM
        """
        self.llm = llm_adapter
        self.transliterator = Transliterator()

    def expand_search_query(self, original_query: str, max_variants: int = 5, tender_type_filter: str = None) -> List[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã.

        Args:
            original_query: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ")
            max_variants: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            tender_type_filter: –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∑–∞–∫—É–ø–∫–∏ ("—Ç–æ–≤–∞—Ä—ã", "—É—Å–ª—É–≥–∏", "—Ä–∞–±–æ—Ç—ã", None –¥–ª—è –≤—Å–µ—Ö)

        Returns:
            –°–ø–∏—Å–æ–∫ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤–∫–ª—é—á–∞—è –æ—Ä–∏–≥–∏–Ω–∞–ª)
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ª–∞—Ç–∏–Ω–∏—Ü—ã
        has_latin = self.transliterator.has_latin(original_query)

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ª–∞—Ç–∏–Ω—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        latin_instructions = ""
        if has_latin:
            transliterated = self.transliterator.transliterate(original_query)
            latin_instructions = f"""
‚ö†Ô∏è –í–ê–ñ–ù–û: –ó–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∞—Ç–∏–Ω—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã (–Ω–∞–∑–≤–∞–Ω–∏—è –±—Ä–µ–Ω–¥–æ–≤).
Zakupki.gov.ru RSS API –ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢ –ª–∞—Ç–∏–Ω–∏—Ü—É, –ø–æ—ç—Ç–æ–º—É:
1. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∏ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫—É—é –≤–µ—Ä—Å–∏—é: "{transliterated}"
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–π –≤–∞—Ä–∏–∞–Ω—Ç—ã –ë–ï–ó –Ω–∞–∑–≤–∞–Ω–∏—è –±—Ä–µ–Ω–¥–∞ (—Ç–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞)
3. –ò—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û –∫–∏—Ä–∏–ª–ª–∏—Ü—É –≤ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö
4. –ù–ï –≤–∫–ª—é—á–∞–π –ª–∞—Ç–∏–Ω—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã

–ü—Ä–∏–º–µ—Ä—ã –ü–†–ê–í–ò–õ–¨–ù–´–• –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –¥–ª—è "Atlas Copco":
‚úÖ "–ê—Ç–ª–∞—Å –ö–æ–ø–∫–æ"
‚úÖ "–∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä—ã –≤–∏–Ω—Ç–æ–≤—ã–µ"
‚úÖ "–ø–Ω–µ–≤–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
‚úÖ "–∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"
‚úÖ "–≤–æ–∑–¥—É—à–Ω—ã–µ –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä—ã"

–ü—Ä–∏–º–µ—Ä—ã –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–• –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:
‚ùå "–∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä—ã Atlas Copco" (—Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∞—Ç–∏–Ω–∏—Ü—É!)
‚ùå "Atlas Copco –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ" (—Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∞—Ç–∏–Ω–∏—Ü—É!)
"""

        # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–∏–ø–∞ –∑–∞–∫—É–ø–∫–∏
        type_filter_instructions = ""
        if tender_type_filter:
            type_mapping = {
                "—Ç–æ–≤–∞—Ä—ã": "–ü–û–°–¢–ê–í–ö–ê —Ç–æ–≤–∞—Ä–æ–≤/–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è/–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤",
                "—É—Å–ª—É–≥–∏": "–û–ö–ê–ó–ê–ù–ò–ï —É—Å–ª—É–≥ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –∞—É—Ç—Å–æ—Ä—Å–∏–Ω–≥ –∏ —Ç.–¥.)",
                "—Ä–∞–±–æ—Ç—ã": "–í–´–ü–û–õ–ù–ï–ù–ò–ï —Ä–∞–±–æ—Ç (—Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –º–æ–Ω—Ç–∞–∂, —Ä–µ–º–æ–Ω—Ç –∏ —Ç.–¥.)"
            }
            type_description = type_mapping.get(tender_type_filter.lower(), tender_type_filter)

            type_filter_instructions = f"""
üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –§–ò–õ–¨–¢–† –ü–û –¢–ò–ü–£ –ó–ê–ö–£–ü–ö–ò:
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç —Ç–æ–ª—å–∫–æ: {type_description}

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –ì–µ–Ω–µ—Ä–∏—Ä—É–π –∑–∞–ø—Ä–æ—Å—ã –¢–û–õ–¨–ö–û –¥–ª—è —Ç–∏–ø–∞ "{tender_type_filter}"
2. –ò—Å–ø–æ–ª—å–∑—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —Ç–∏–ø–∞ –∑–∞–∫—É–ø–∫–∏:
   - –î–ª—è "—Ç–æ–≤–∞—Ä—ã": "–ø–æ—Å—Ç–∞–≤–∫–∞", "–∑–∞–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤", "–ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏–µ", "–∑–∞–∫—É–ø–∫–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
   - –î–ª—è "—É—Å–ª—É–≥–∏": "–æ–∫–∞–∑–∞–Ω–∏–µ —É—Å–ª—É–≥", "—É—Å–ª—É–≥–∏ –ø–æ", "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ", "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏"
   - –î–ª—è "—Ä–∞–±–æ—Ç—ã": "–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç", "—Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã", "—Ä–µ–º–æ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã", "–º–æ–Ω—Ç–∞–∂–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"

3. –ò–ó–ë–ï–ì–ê–ô –∑–∞–ø—Ä–æ—Å–æ–≤ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤:
   {"- –ù–ï –≤–∫–ª—é—á–∞–π '—Ä–µ–º–æ–Ω—Ç', '–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ', '—É—Å–ª—É–≥–∏ –ø–æ —Ä–µ–º–æ–Ω—Ç—É' –µ—Å–ª–∏ –∏—â–µ–º —Ç–æ–≤–∞—Ä—ã" if tender_type_filter == "—Ç–æ–≤–∞—Ä—ã" else ""}
   {"- –ù–ï –≤–∫–ª—é—á–∞–π '–ø–æ—Å—Ç–∞–≤–∫–∞', '–∑–∞–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤' –µ—Å–ª–∏ –∏—â–µ–º —É—Å–ª—É–≥–∏" if tender_type_filter == "—É—Å–ª—É–≥–∏" else ""}
   {"- –ù–ï –≤–∫–ª—é—á–∞–π '–ø–æ—Å—Ç–∞–≤–∫–∞', '–∑–∞–∫—É–ø–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤' –µ—Å–ª–∏ –∏—â–µ–º —Ä–∞–±–æ—Ç—ã" if tender_type_filter == "—Ä–∞–±–æ—Ç—ã" else ""}

–ü–†–ò–ú–ï–†–´ –¥–ª—è "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ" (—Ç–∏–ø: —Ç–æ–≤–∞—Ä—ã):
‚úÖ "–ø–æ—Å—Ç–∞–≤–∫–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
‚úÖ "–∑–∞–∫—É–ø–∫–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤ –∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö"
‚úÖ "–ø—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
‚ùå "—Ä–µ–º–æ–Ω—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" (—ç—Ç–æ —É—Å–ª—É–≥–∞!)
‚ùå "—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤" (—ç—Ç–æ —É—Å–ª—É–≥–∞!)
"""

        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–∫—É–ø–∫–∞–º –≤ –†–æ—Å—Å–∏–∏.

–ó–ê–î–ê–ß–ê: –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ–Ω–¥–µ—Ä–æ–≤ –Ω–∞ zakupki.gov.ru.

–û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ó–ê–ü–†–û–°: "{original_query}"
{latin_instructions}
{type_filter_instructions}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –í–∫–ª—é—á–∏ —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –±–ª–∏–∑–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
2. –í–∫–ª—é—á–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ö–æ–¥—è—Ç –≤ —ç—Ç–æ –ø–æ–Ω—è—Ç–∏–µ
3. –í–∫–ª—é—á–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤
4. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –≥–æ—Å–∑–∞–∫—É–ø–æ–∫
5. –í–µ—Ä–Ω–∏ {max_variants} –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
6. –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –ö–ò–†–ò–õ–õ–ò–¶–£ –≤ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö (–±–µ–∑ –ª–∞—Ç–∏–Ω—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤!)

–ü–†–ò–ú–ï–†–´:
- –î–ª—è "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã, –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤, –ø–µ—Ä–∏—Ñ–µ—Ä–∏–π–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Å–∏—Å—Ç–µ–º–Ω—ã–µ –±–ª–æ–∫–∏
- –î–ª—è "–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ": –ª–∏—Ü–µ–Ω–∑–∏–∏ –Ω–∞ –ü–û, –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–æ–µ –ü–û, –æ—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ü–û

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{{
  "original": "–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å",
  "expanded": [
    "–≤–∞—Ä–∏–∞–Ω—Ç 1",
    "–≤–∞—Ä–∏–∞–Ω—Ç 2",
    "–≤–∞—Ä–∏–∞–Ω—Ç 3"
  ],
  "reasoning": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω—ã —ç—Ç–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã"
}}
"""

        try:
            response = self.llm.generate(system_prompt="–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–∫—É–ø–∫–∞–º –≤ –†–æ—Å—Å–∏–∏.", user_prompt=prompt)

            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            # –ò—â–µ–º JSON –≤ –æ—Ç–≤–µ—Ç–µ
            start_idx = response.find('{')
            end_idx = response.rfind('}') + 1

            if start_idx != -1 and end_idx > start_idx:
                json_str = response[start_idx:end_idx]
                result = json.loads(json_str)

                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
                queries = []

                # –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∞—Ç–∏–Ω–∏—Ü–∞
                if has_latin:
                    transliterated = self.transliterator.transliterate(original_query)
                    queries.append(transliterated)
                    print(f"\nüí° –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ '{original_query}':")
                    print(f"   üîÑ –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è: '{transliterated}'")
                else:
                    queries.append(original_query)
                    print(f"\nüí° –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ '{original_query}':")

                if 'expanded' in result and isinstance(result['expanded'], list):
                    # –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã, —É–±–∏—Ä–∞–µ–º —Ç–µ —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∞—Ç –ª–∞—Ç–∏–Ω–∏—Ü—É
                    filtered_variants = []
                    skipped_variants = []

                    for variant in result['expanded'][:max_variants * 2]:  # –ë–µ—Ä–µ–º —Å –∑–∞–ø–∞—Å–æ–º
                        if self.transliterator.has_latin(variant):
                            skipped_variants.append(variant)
                        else:
                            filtered_variants.append(variant)

                        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è –∫–æ–≥–¥–∞ –Ω–∞–±—Ä–∞–ª–∏ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
                        if len(filtered_variants) >= max_variants - 1:
                            break

                    queries.extend(filtered_variants[:max_variants - 1])

                    print(f"   üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: {len(queries) - 1}")
                    for i, q in enumerate(queries[1:], 1):
                        print(f"      {i}. {q}")

                    if skipped_variants:
                        print(f"   ‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å –ª–∞—Ç–∏–Ω–∏—Ü–µ–π: {len(skipped_variants)}")
                        for variant in skipped_variants[:3]:
                            print(f"      ‚ùå {variant}")

                if 'reasoning' in result:
                    print(f"   ü§î –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: {result['reasoning']}")

                return queries

        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ LLM: {e}")

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∞—Ç–∏–Ω–∏—Ü–∞
        if has_latin:
            transliterated = self.transliterator.transliterate(original_query)
            return [transliterated]

        return [original_query]

    def generate_okpd_categories(self, query: str) -> List[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–¥—ã –û–ö–ü–î2 –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞.

        Args:
            query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å

        Returns:
            –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ –û–ö–ü–î2
        """
        prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–¥—ã –û–ö–ü–î2 (–û–±—â–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–¥—É–∫—Ü–∏–∏) –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: "{query}"

–í–µ—Ä–Ω–∏ 3-5 –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–æ–¥–æ–≤ –û–ö–ü–î2 –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
  "codes": [
    {{"code": "26.20.1", "name": "–ö–æ–º–ø—å—é—Ç–µ—Ä—ã –∏ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–π–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"}},
    {{"code": "26.30.5", "name": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–µ"}}
  ]
}}
"""

        try:
            response = self.llm.generate(system_prompt="–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–∫—É–ø–∫–∞–º –≤ –†–æ—Å—Å–∏–∏.", user_prompt=prompt)

            start_idx = response.find('{')
            end_idx = response.rfind('}') + 1

            if start_idx != -1 and end_idx > start_idx:
                json_str = response[start_idx:end_idx]
                result = json.loads(json_str)

                if 'codes' in result:
                    return [item['code'] for item in result['codes']]

        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –û–ö–ü–î2: {e}")

        return []


class TenderDataExtractor:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ç–µ–Ω–¥–µ—Ä–µ —Å –ø–æ–º–æ—â—å—é LLM."""

    def __init__(self, llm_adapter):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.

        Args:
            llm_adapter: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LLM
        """
        self.llm = llm_adapter

    def extract_tender_details(self, tender_summary: str) -> Dict[str, Any]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–µ–Ω–¥–µ—Ä–∞.

        Args:
            tender_summary: –û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–Ω–¥–µ—Ä–∞ –∏–∑ RSS –∏–ª–∏ HTML

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        """
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–Ω–¥–µ—Ä–∞ –∏ –∏–∑–≤–ª–µ–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–û–ü–ò–°–ê–ù–ò–ï –¢–ï–ù–î–ï–†–ê:
{tender_summary[:3000]}

–ó–ê–î–ê–ß–ê: –ò–∑–≤–ª–µ–∫–∏ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –≤–µ—Ä–Ω–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:

{{
  "tender_type": "–¢–∏–ø –∑–∞–∫—É–ø–∫–∏ (—Ç–æ–≤–∞—Ä—ã/—Ä–∞–±–æ—Ç—ã/—É—Å–ª—É–≥–∏)",
  "categories": ["–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è 2"],
  "region": "–†–µ–≥–∏–æ–Ω",
  "customer_type": "–¢–∏–ø –∑–∞–∫–∞–∑—á–∏–∫–∞ (—Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π/—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π/–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π)",
  "submission_deadline": "–°—Ä–æ–∫ –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–æ–∫ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)",
  "winner_determination_date": "–°—Ä–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)",
  "payment_terms": "–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)",
  "quantity_info": "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ç–æ–≤–∞—Ä–æ–≤ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)",
  "okpd_codes": ["–ö–æ–¥ –û–ö–ü–î2 –µ—Å–ª–∏ –µ—Å—Ç—å"]
}}

–í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–π null
- –î–ª—è categories —É–∫–∞–∂–∏ –≤—Å–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥
- region - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
- submission_deadline - —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–µ–º–∞ –∑–∞—è–≤–æ–∫
- winner_determination_date - –¥–∞—Ç–∞ –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
- payment_terms - –ª—é–±–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤–∞–Ω—Å, —Ä–∞—Å—Å—Ä–æ—á–∫–µ, –ø–æ—Ä—è–¥–∫–µ –æ–ø–ª–∞—Ç—ã
"""

        try:
            response = self.llm.generate(system_prompt="–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–∫—É–ø–∫–∞–º –≤ –†–æ—Å—Å–∏–∏.", user_prompt=prompt)

            start_idx = response.find('{')
            end_idx = response.rfind('}') + 1

            if start_idx != -1 and end_idx > start_idx:
                json_str = response[start_idx:end_idx]
                result = json.loads(json_str)
                return result

        except Exception as e:
            print(f"   ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ LLM: {e}")

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        return {
            "tender_type": None,
            "categories": [],
            "region": None,
            "customer_type": None,
            "submission_deadline": None,
            "winner_determination_date": None,
            "payment_terms": None,
            "quantity_info": None,
            "okpd_codes": []
        }


def main():
    """–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è."""
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent))

    from analyzers.tender_analyzer import TenderAnalyzer
    from utils.config_loader import ConfigLoader

    print("\n" + "="*70)
    print("  –¢–ï–°–¢ –£–ú–ù–û–ì–û –†–ê–°–®–ò–†–ï–ù–ò–Ø –ü–û–ò–°–ö–ê")
    print("="*70 + "\n")

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    config = ConfigLoader()
    llm_config = config.get_llm_config()

    # –°–æ–∑–¥–∞–µ–º TenderAnalyzer
    tender_analyzer = TenderAnalyzer(
        api_key=llm_config['api_key'],
        provider=llm_config['provider'],
        model_fast=llm_config.get('model_fast')
    )

    # –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—à–∏—Ä–∏—Ç–µ–ª—å
    expander = SmartSearchExpander(tender_analyzer.llm)

    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
    test_queries = [
        "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
        "–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ",
        "–∫–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã"
    ]

    for query in test_queries:
        print(f"\n{'‚îÄ'*70}")
        print(f"–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å: '{query}'")
        print(f"{'‚îÄ'*70}")

        expanded = expander.expand_search_query(query, max_variants=5)

        print(f"\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è ({len(expanded)} –∑–∞–ø—Ä–æ—Å–æ–≤):")
        for i, q in enumerate(expanded, 1):
            print(f"   {i}. {q}")

    print("\n" + "="*70)


if __name__ == "__main__":
    main()
