#!/bin/bash

# ๐ ะะฒัะพะผะฐัะธัะตัะบะธะน ะดะตะฟะปะพะน V2.0 ะฝะฐ ัะตัะฒะตั
# ะญัะพั ัะบัะธะฟั ะฝัะถะฝะพ ะทะฐะฟัััะธัั ะะ ะกะะะะะะ ะณะดะต ัะฐะฑะพัะฐะตั ะฑะพั

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}  ๐ ะะะะะะ TENDER-AI-BOT V2.0${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ะัะพะฒะตัะบะฐ ััะพ ะผั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "docker-compose.yml" ]; then
    echo -e "${RED}โ ะัะธะฑะบะฐ: docker-compose.yml ะฝะต ะฝะฐะนะดะตะฝ${NC}"
    echo -e "${YELLOW}ะะฐะฟัััะธัะต ัะบัะธะฟั ะธะท ะบะพัะฝะตะฒะพะน ะดะธัะตะบัะพัะธะธ ะฟัะพะตะบัะฐ${NC}"
    exit 1
fi

# ะคัะฝะบัะธั ะดะปั ะฒะพะฟัะพัะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปั
ask_continue() {
    read -p "$(echo -e ${YELLOW}$1 [y/N]:${NC}) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}ะัะผะตะฝะตะฝะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ${NC}"
        exit 1
    fi
}

# ะจะฐะณ 1: ะัะพะฒะตัะบะฐ ััะฐัััะฐ
echo -e "${BLUE}๐ ะจะฐะณ 1/6: ะัะพะฒะตัะบะฐ ัะตะบััะตะณะพ ัะพััะพัะฝะธั...${NC}"
echo ""

# ะัะพะฒะตัะบะฐ Docker
if ! command -v docker &> /dev/null; then
    echo -e "${RED}โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ${NC}"
    exit 1
fi

if ! command -v docker-compose &> /dev/null; then
    echo -e "${RED}โ Docker Compose ะฝะต ัััะฐะฝะพะฒะปะตะฝ${NC}"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะทะฐะฟััะตะฝ ะปะธ ะบะพะฝัะตะนะฝะตั
CONTAINER_RUNNING=$(docker ps -q -f name=tender-ai-bot)
if [ -n "$CONTAINER_RUNNING" ]; then
    echo -e "${GREEN}โ ะะพะฝัะตะนะฝะตั tender-ai-bot ัะฐะฑะพัะฐะตั${NC}"
    NEED_RESTART=true
else
    echo -e "${YELLOW}โ ะะพะฝัะตะนะฝะตั tender-ai-bot ะฝะต ะทะฐะฟััะตะฝ${NC}"
    NEED_RESTART=false
fi

# ะะพะบะฐะทัะฒะฐะตะผ ัะตะบัััั ะฒะตััะธั
CURRENT_COMMIT=$(git log --oneline -1 2>/dev/null || echo "unknown")
echo -e "${BLUE}ะขะตะบััะธะน ะบะพะผะผะธั: ${NC}${CURRENT_COMMIT}"
echo ""

# ะจะฐะณ 2: ะัะบะฐะฟ ะฑะฐะทั ะดะฐะฝะฝัั
echo -e "${BLUE}๐พ ะจะฐะณ 2/6: ะกะพะทะดะฐะฝะธะต ะฑัะบะฐะฟะฐ ะฑะฐะทั ะดะฐะฝะฝัั...${NC}"
echo ""

DB_PATH="bot/database/tender_bot.db"
if [ -f "$DB_PATH" ]; then
    BACKUP_NAME="bot/database/tender_bot.db.backup_$(date +%Y%m%d_%H%M%S)"
    cp "$DB_PATH" "$BACKUP_NAME"
    echo -e "${GREEN}โ ะัะบะฐะฟ ัะพะทะดะฐะฝ: $BACKUP_NAME${NC}"
else
    echo -e "${YELLOW}โ ะะฐะทะฐ ะดะฐะฝะฝัั ะฝะต ะฝะฐะนะดะตะฝะฐ (ะฑัะดะตั ัะพะทะดะฐะฝะฐ ะฟัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต)${NC}"
fi
echo ""

# ะจะฐะณ 3: ะััะฐะฝะพะฒะบะฐ ะบะพะฝัะตะนะฝะตัะฐ
if [ "$NEED_RESTART" = true ]; then
    echo -e "${BLUE}๐ ะจะฐะณ 3/6: ะััะฐะฝะพะฒะบะฐ ะบะพะฝัะตะนะฝะตัะฐ...${NC}"
    echo ""

    docker-compose down

    echo -e "${GREEN}โ ะะพะฝัะตะนะฝะตั ะพััะฐะฝะพะฒะปะตะฝ${NC}"
    echo -e "${YELLOW}โณ ะะถะธะดะฐะฝะธะต 10 ัะตะบัะฝะด ะดะปั ะพัะฒะพะฑะพะถะดะตะฝะธั Telegram ัะพะตะดะธะฝะตะฝะธะน...${NC}"
    sleep 10
    echo ""
else
    echo -e "${BLUE}โญ๏ธ  ะจะฐะณ 3/6: ะัะพะฟััะตะฝ (ะบะพะฝัะตะนะฝะตั ะฝะต ะฑัะป ะทะฐะฟััะตะฝ)${NC}"
    echo ""
fi

# ะจะฐะณ 4: ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ
echo -e "${BLUE}๐ฅ ะจะฐะณ 4/6: ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ะธะท GitHub...${NC}"
echo ""

# ะะพะบะฐะทัะฒะฐะตะผ ััะพ ะฑัะดะตั ะพะฑะฝะพะฒะปะตะฝะพ
echo -e "${YELLOW}ะัะพะฒะตัะบะฐ ะพะฑะฝะพะฒะปะตะฝะธะน...${NC}"
git fetch origin
NEW_COMMITS=$(git log HEAD..origin/main --oneline)

if [ -z "$NEW_COMMITS" ]; then
    echo -e "${GREEN}โ ะะพะด ัะถะต ะฐะบััะฐะปะตะฝ${NC}"
else
    echo -e "${YELLOW}ะัะดัั ะฟัะธะผะตะฝะตะฝั ัะปะตะดัััะธะต ะธะทะผะตะฝะตะฝะธั:${NC}"
    echo "$NEW_COMMITS"
    echo ""
    ask_continue "ะัะพะดะพะปะถะธัั ะพะฑะฝะพะฒะปะตะฝะธะต?"
fi

# ะะฑะฝะพะฒะปัะตะผ ะบะพะด
git pull origin main

# ะัะพะฒะตััะตะผ ััะพ ะผั ะฝะฐ ะฟัะฐะฒะธะปัะฝะพะผ ะบะพะผะผะธัะต
UPDATED_COMMIT=$(git log --oneline -1)
echo -e "${GREEN}โ ะะพะด ะพะฑะฝะพะฒะปะตะฝ: ${NC}${UPDATED_COMMIT}"
echo ""

# ะจะฐะณ 5: ะะตัะตัะฑะพัะบะฐ ะพะฑัะฐะทะฐ
echo -e "${BLUE}๐จ ะจะฐะณ 5/6: ะะตัะตัะฑะพัะบะฐ Docker ะพะฑัะฐะทะฐ...${NC}"
echo ""

docker-compose build --no-cache

echo -e "${GREEN}โ ะะฑัะฐะท ะฟะตัะตัะพะฑัะฐะฝ${NC}"
echo ""

# ะจะฐะณ 6: ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะฐ
echo -e "${BLUE}๐ ะจะฐะณ 6/6: ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะฐ...${NC}"
echo ""

docker-compose up -d

# ะะดะตะผ ะทะฐะฟััะบะฐ
echo -e "${YELLOW}โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ (15 ัะตะบัะฝะด)...${NC}"
sleep 15

# ะัะพะฒะตััะตะผ ััะฐััั
CONTAINER_STATUS=$(docker ps -f name=tender-ai-bot --format "{{.Status}}")
if [ -n "$CONTAINER_STATUS" ]; then
    echo -e "${GREEN}โ ะะพะฝัะตะนะฝะตั ะทะฐะฟััะตะฝ: $CONTAINER_STATUS${NC}"
else
    echo -e "${RED}โ ะะพะฝัะตะนะฝะตั ะฝะต ะทะฐะฟััะตะฝ!${NC}"
    echo -e "${YELLOW}ะัะพะฒะตัััะต ะปะพะณะธ: docker-compose logs -f${NC}"
    exit 1
fi
echo ""

# ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ
echo -e "${BLUE}๐ ะะพัะปะตะดะฝะธะต 20 ัััะพะบ ะปะพะณะพะฒ:${NC}"
echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
docker-compose logs --tail=20
echo -e "${YELLOW}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ะัะพะฒะตัะบะฐ ะฝะฐ ะพัะธะฑะบะธ ะฒ ะปะพะณะฐั
ERRORS=$(docker-compose logs --tail=50 | grep -i "error\|failed\|exception" | wc -l)
if [ "$ERRORS" -gt 0 ]; then
    echo -e "${YELLOW}โ ะะฑะฝะฐััะถะตะฝะพ $ERRORS ะพัะธะฑะพะบ ะฒ ะปะพะณะฐั${NC}"
    echo -e "${YELLOW}ะัะพะฒะตัััะต ะดะตัะฐะปัะฝะพ: docker-compose logs -f${NC}"
else
    echo -e "${GREEN}โ ะัะธะฑะพะบ ะฒ ะปะพะณะฐั ะฝะต ะพะฑะฝะฐััะถะตะฝะพ${NC}"
fi
echo ""

# ะัะพะฒะตัะบะฐ ะะ
echo -e "${BLUE}๐๏ธ  ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั...${NC}"
if [ -f "$DB_PATH" ]; then
    # ะัะพะฒะตััะตะผ ััะพ ะฝะพะฒะฐั ัะฐะฑะปะธัะฐ ัะพะทะดะฐะฝะฐ
    TABLE_EXISTS=$(docker-compose exec -T tender-bot sqlite3 /app/bot/database/tender_bot.db ".tables" 2>/dev/null | grep -c "tender_analyses" || true)

    if [ "$TABLE_EXISTS" -gt 0 ]; then
        echo -e "${GREEN}โ ะขะฐะฑะปะธัะฐ tender_analyses ัะพะทะดะฐะฝะฐ${NC}"

        # ะะพะบะฐะทัะฒะฐะตะผ ััะฐัะธััะธะบั
        CACHE_COUNT=$(docker-compose exec -T tender-bot sqlite3 /app/bot/database/tender_bot.db "SELECT COUNT(*) FROM tender_analyses" 2>/dev/null || echo "0")
        echo -e "${BLUE}  ะะฐะฟะธัะตะน ะฒ ะบััะต: ${NC}${CACHE_COUNT}"
    else
        echo -e "${YELLOW}โ ะขะฐะฑะปะธัะฐ tender_analyses ะตัะต ะฝะต ัะพะทะดะฐะฝะฐ (ัะพะทะดะฐัััั ะฟัะธ ะฟะตัะฒะพะผ ะฐะฝะฐะปะธะทะต)${NC}"
    fi
else
    echo -e "${YELLOW}โ ะะฐะทะฐ ะดะฐะฝะฝัั ะตัะต ะฝะต ัะพะทะดะฐะฝะฐ${NC}"
fi
echo ""

# ะัะพะณะธ
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${GREEN}  โ ะะะะะะ ะะะะะะจะะ ะฃะกะะะจะะ!${NC}"
echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
echo -e "${BLUE}๐ ะะตััะธั:${NC} $(git log --oneline -1)"
echo -e "${BLUE}๐ณ ะะพะฝัะตะนะฝะตั:${NC} $CONTAINER_STATUS"
echo -e "${BLUE}๐พ ะัะบะฐะฟ ะะ:${NC} $BACKUP_NAME"
echo ""
echo -e "${YELLOW}๐ ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั:${NC}"
echo -e "  ${BLUE}docker-compose logs -f${NC}          # ะกะผะพััะตัั ะปะพะณะธ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ"
echo -e "  ${BLUE}docker-compose restart${NC}          # ะะตัะตะทะฐะฟัััะธัั ะฑะพัะฐ"
echo -e "  ${BLUE}docker-compose exec tender-bot bash${NC}  # ะะพะนัะธ ะฒ ะบะพะฝัะตะนะฝะตั"
echo ""
echo -e "${GREEN}๐ ะะพั ะพะฑะฝะพะฒะปะตะฝ ะดะพ V2.0 ะธ ะณะพัะพะฒ ะบ ะธัะฟะพะปัะทะพะฒะฐะฝะธั!${NC}"
echo ""
