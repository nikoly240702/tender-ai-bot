{% extends "base.html" %}

{% block title %}–†–∞—Å—Å—ã–ª–∫–∞{% endblock %}

{% block content %}
<div class="top-bar">
    <h4 class="mb-0">–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</h4>
    <a href="/broadcast/history" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-clock-history"></i> –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫
    </a>
</div>

{% if request.query_params.get('sent') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞! –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if request.query_params.get('refresh_sent') %}
<div class="alert alert-info alert-dismissible fade show" role="alert">
    üîÑ –ó–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω {{ request.query_params.get('refresh_sent') }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <!-- –§–æ—Ä–º–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ -->
    <div class="col-lg-8">
        <div class="card card-custom">
            <div class="card-header">
                <i class="bi bi-megaphone me-2"></i> –ù–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞
            </div>
            <div class="card-body">
                <form action="/broadcast/send" method="post">
                    <div class="mb-3">
                        <label class="form-label">–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</label>
                        <select name="target_tier" class="form-select">
                            <option value="all">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ({{ tier_stats.get('all', 0) }})</option>
                            <option value="trial">–ü—Ä–æ–±–Ω—ã–π ({{ tier_stats.get('trial', 0) }})</option>
                            <option value="basic">Basic ({{ tier_stats.get('basic', 0) }})</option>
                            <option value="premium">Premium ({{ tier_stats.get('premium', 0) }})</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
                        <textarea name="message" class="form-control" rows="6"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è... (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HTML)" required></textarea>
                        <div class="form-text">
                            –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è HTML —Ç–µ–≥–∏: &lt;b&gt;, &lt;i&gt;, &lt;u&gt;, &lt;a href=""&gt;, &lt;code&gt;
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="col-lg-4">
        <!-- –û–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö -->
        <div class="card card-custom mb-4" style="border-left: 4px solid #0d6efd;">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-arrow-repeat me-2"></i> –û–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ –¥–ª—è –≤—Å–µ—Ö
            </div>
            <div class="card-body">
                <p class="card-text small text-muted mb-3">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞.
                    –≠—Ç–æ –æ–±–Ω–æ–≤–∏—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏ –º–µ–Ω—é —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
                </p>
                <form action="/force-refresh" method="post">
                    <div class="mb-3">
                        <label class="form-label small">–°–æ–æ–±—â–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                        <textarea name="message" class="form-control form-control-sm" rows="2"
                                  placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-arrow-repeat"></i> –û–±–Ω–æ–≤–∏—Ç—å —É –≤—Å–µ—Ö
                    </button>
                </form>
            </div>
        </div>

        <div class="card card-custom mb-4">
            <div class="card-header">
                <i class="bi bi-people me-2"></i> –ê—É–¥–∏—Ç–æ—Ä–∏—è –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>–í—Å–µ–≥–æ:</span>
                    <strong>{{ tier_stats.get('all', 0) }}</strong>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge badge-tier badge-free">Free</span>
                    <span>{{ tier_stats.get('free', 0) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge" style="background: #d4edda; color: #155724;">Trial</span>
                    <span>{{ tier_stats.get('trial', 0) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="badge badge-tier badge-basic">Basic</span>
                    <span>{{ tier_stats.get('basic', 0) }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span class="badge badge-tier badge-premium">Premium</span>
                    <span>{{ tier_stats.get('premium', 0) }}</span>
                </div>
            </div>
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ -->
        <div class="card card-custom">
            <div class="card-header">
                <i class="bi bi-clock me-2"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏
            </div>
            <div class="card-body p-0">
                {% if history %}
                <ul class="list-group list-group-flush">
                    {% for broadcast in history[:5] %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <small class="text-muted">{{ broadcast.sent_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                <div class="text-truncate" style="max-width: 200px;">
                                    {{ broadcast.message_text[:50] }}{% if broadcast.message_text|length > 50 %}...{% endif %}
                                </div>
                            </div>
                            <span class="badge bg-secondary">{{ broadcast.target_tier }}</span>
                        </div>
                        <small class="text-success">{{ broadcast.successful }}</small> /
                        <small class="text-danger">{{ broadcast.failed }}</small> /
                        <small class="text-muted">{{ broadcast.total_recipients }}</small>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="text-center text-muted py-4">
                    –†–∞—Å—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ –±—ã–ª–æ
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
