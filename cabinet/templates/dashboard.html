<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ–Ω–¥–µ—Ä—ã ‚Äî Tender Sniper</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@700;900&family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/cabinet/static/cabinet.css">
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{--bg:#0a0e17;--bg2:#111623;--bg3:#181e2e;--surface:rgba(255,255,255,0.04);--line:rgba(255,255,255,0.07);--gold:#d4a853;--gold-dim:rgba(212,168,83,0.12);--gold-line:rgba(212,168,83,0.25);--white:#f0f0f0;--gray:#6b7a90;--gray2:#99a8b8;--green:#3dd68c;--red:#e74c3c;--sidebar-w:240px}
    body{background:var(--bg);color:var(--white);font-family:'Manrope',system-ui,sans-serif;font-size:15px;line-height:1.55;display:flex;min-height:100vh}
    .sidebar{width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--line);padding:24px 16px;display:flex;flex-direction:column;position:fixed;height:100vh}
    .sidebar .logo{font-family:'Unbounded',sans-serif;font-size:16px;font-weight:900;margin-bottom:32px;padding:0 8px}.sidebar .logo span{color:var(--gold)}
    .sidebar nav{flex:1}
    .sidebar a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;color:var(--gray2);text-decoration:none;font-size:14px;font-weight:500;transition:all 0.15s;margin-bottom:2px}
    .sidebar a:hover{background:var(--surface);color:var(--white)}.sidebar a.active{background:var(--gold-dim);color:var(--gold)}
    .sidebar .icon{width:20px;text-align:center}
    .sidebar .bottom{border-top:1px solid var(--line);padding-top:16px;margin-top:auto}.sidebar .bottom a{color:var(--gray);font-size:13px}
    .main{margin-left:var(--sidebar-w);flex:1;padding:32px 40px}
    .page-header{margin-bottom:28px}.page-header h1{font-family:'Unbounded',sans-serif;font-size:22px;font-weight:700;margin-bottom:4px}.page-header p{color:var(--gray2);font-size:14px}
    .card{background:var(--bg2);border:1px solid var(--line);border-radius:12px;padding:24px;margin-bottom:16px}
    .tbl{width:100%;border-collapse:collapse}.tbl th{text-align:left;padding:10px 12px;font-size:12px;font-weight:600;color:var(--gray);text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--line)}.tbl td{padding:12px;border-bottom:1px solid var(--line);font-size:14px;vertical-align:top}.tbl tr:hover td{background:var(--surface)}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-family:'Manrope',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all 0.15s;text-decoration:none}
    .btn-gold{background:var(--gold);color:#0a0e17}.btn-gold:hover{opacity:0.9}
    .btn-outline{background:transparent;border:1px solid var(--line);color:var(--white)}.btn-outline:hover{border-color:var(--gold-line);color:var(--gold)}
    .btn-sm{padding:6px 12px;font-size:12px}
    .badge{display:inline-block;padding:3px 8px;border-radius:4px;font-size:11px;font-weight:600}
    .badge-green{background:rgba(61,214,140,0.15);color:var(--green)}.badge-gold{background:var(--gold-dim);color:var(--gold)}.badge-gray{background:var(--surface);color:var(--gray2)}
    .loading{text-align:center;padding:40px;color:var(--gray)}
    .spinner{width:32px;height:32px;border:3px solid var(--line);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 12px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .pagination{display:flex;gap:8px;margin-top:20px;justify-content:center}
    .pagination button{padding:6px 12px;border-radius:6px;background:var(--bg3);border:1px solid var(--line);color:var(--white);cursor:pointer;font-size:13px}
    .pagination button.active{background:var(--gold-dim);border-color:var(--gold-line);color:var(--gold)}
    .pagination button:disabled{opacity:0.3;cursor:not-allowed}
    .toast{position:fixed;bottom:24px;right:24px;padding:12px 20px;border-radius:8px;background:var(--bg3);border:1px solid var(--gold-line);color:var(--white);font-size:14px;z-index:1000;opacity:0;transition:opacity 0.3s;pointer-events:none}.toast.show{opacity:1;pointer-events:auto}
    .tender-name{max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tender-name a{color:var(--white);text-decoration:none}.tender-name a:hover{color:var(--gold)}
    @media(max-width:768px){.sidebar{width:0;overflow:hidden;padding:0}.main{margin-left:0;padding:16px}}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">TENDER<span>SNIPER</span></div>
    <nav>
      <a href="/cabinet/" class="active"><span class="icon">üìä</span> –¢–µ–Ω–¥–µ—Ä—ã</a>
      <a href="/cabinet/profile"><span class="icon">üè¢</span> –ü—Ä–æ—Ñ–∏–ª—å</a>
      <a href="/cabinet/documents"><span class="icon">üìÑ</span> –î–æ–∫—É–º–µ–Ω—Ç—ã</a>
      <a href="/cabinet/filters"><span class="icon">üéØ</span> –§–∏–ª—å—Ç—Ä—ã</a>
    </nav>
    <div class="bottom">
      <a href="https://t.me/TenderSniperBot">–ë–æ—Ç –≤ Telegram</a>
      <a href="/cabinet/logout">–í—ã–π—Ç–∏</a>
    </div>
  </aside>

  <main class="main">
    <div class="page-header">
      <h1>–ò—Å—Ç–æ—Ä–∏—è —Ç–µ–Ω–¥–µ—Ä–æ–≤</h1>
      <p>–í—Å–µ —Ç–µ–Ω–¥–µ—Ä—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤–∞—à–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏</p>
    </div>

    <div class="card" id="tenders-card">
      <div class="loading" id="loading">
        <div class="spinner"></div>
        –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–Ω–¥–µ—Ä–æ–≤...
      </div>
      <table class="tbl" id="tenders-table" style="display:none">
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–¶–µ–Ω–∞</th>
            <th>–ó–∞–∫–∞–∑—á–∏–∫</th>
            <th>–§–∏–ª—å—Ç—Ä</th>
            <th>–î–∞—Ç–∞</th>
            <th>–î–æ–∫—É–º–µ–Ω—Ç—ã</th>
          </tr>
        </thead>
        <tbody id="tenders-body"></tbody>
      </table>
      <div class="pagination" id="pagination"></div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    function showToast(msg, dur=3000){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),dur)}
    function fmtPrice(p){if(!p)return'‚Äî';const n=parseFloat(p);if(n>=1e6)return(n/1e6).toFixed(2)+' –º–ª–Ω';if(n>=1e3)return(n/1e3).toFixed(1)+' —Ç—ã—Å.';return n.toFixed(0)+' —Ä—É–±.'}
    function fmtDate(d){if(!d)return'‚Äî';return new Date(d).toLocaleDateString('ru-RU')}

    let currentPage = 1;
    const LIMIT = 30;

    async function loadTenders(page) {
      currentPage = page;
      const resp = await fetch(`/cabinet/api/tenders?page=${page}&limit=${LIMIT}`);
      if (resp.status === 401) { location.href = '/cabinet/login'; return; }
      const data = await resp.json();

      document.getElementById('loading').style.display = 'none';
      document.getElementById('tenders-table').style.display = 'table';

      const tbody = document.getElementById('tenders-body');
      tbody.innerHTML = '';

      if (!data.tenders || data.tenders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:40px">–¢–µ–Ω–¥–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ –±–æ—Ç–µ.</td></tr>';
        return;
      }

      data.tenders.forEach(t => {
        const url = t.url ? `<a href="${t.url}" target="_blank">${(t.name||'').substring(0,60)}${(t.name||'').length>60?'...':''}</a>` : (t.name||'').substring(0,60);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="tender-name">${url}</td>
          <td>${fmtPrice(t.price)}</td>
          <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.customer_name||'‚Äî'}</td>
          <td><span class="badge badge-gold">${t.filter_name||'‚Äî'}</span></td>
          <td style="white-space:nowrap">${fmtDate(t.sent_at)}</td>
          <td><button class="btn btn-sm btn-outline" onclick="generateDocs('${t.number}')">üìÑ –°–æ–∑–¥–∞—Ç—å</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Pagination
      const totalPages = Math.ceil(data.total / LIMIT);
      const pag = document.getElementById('pagination');
      pag.innerHTML = '';
      if (totalPages > 1) {
        const prev = document.createElement('button');
        prev.textContent = '‚Üê';
        prev.disabled = page <= 1;
        prev.onclick = () => loadTenders(page - 1);
        pag.appendChild(prev);

        for (let i = 1; i <= Math.min(totalPages, 10); i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          if (i === page) btn.classList.add('active');
          btn.onclick = () => loadTenders(i);
          pag.appendChild(btn);
        }

        const next = document.createElement('button');
        next.textContent = '‚Üí';
        next.disabled = page >= totalPages;
        next.onclick = () => loadTenders(page + 1);
        pag.appendChild(next);
      }
    }

    async function generateDocs(tenderNumber) {
      showToast('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...');
      try {
        const resp = await fetch(`/cabinet/api/documents/generate/${tenderNumber}`, {method: 'POST'});
        const data = await resp.json();
        if (data.ok) {
          showToast('–î–æ–∫—É–º–µ–Ω—Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã! –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–î–æ–∫—É–º–µ–Ω—Ç—ã".');
        } else {
          showToast(data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
        }
      } catch(e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message);
      }
    }

    loadTenders(1);
  </script>
</body>
</html>
