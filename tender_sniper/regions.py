"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–º–∏ –æ–∫—Ä—É–≥–∞–º–∏ –∏ —Ä–µ–≥–∏–æ–Ω–∞–º–∏ –†–æ—Å—Å–∏–∏.

–§—É–Ω–∫—Ü–∏–∏:
- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –§–û –∏ —Ä–µ–≥–∏–æ–Ω–æ–≤
- Fuzzy matching –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–æ–≤
- –ü–∞—Ä—Å–∏–Ω–≥ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
"""

from typing import List, Dict, Tuple, Optional
from difflib import get_close_matches
import re


# –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–≥–∞ –†–æ—Å—Å–∏–∏ —Å —Ä–µ–≥–∏–æ–Ω–∞–º–∏
FEDERAL_DISTRICTS = {
    "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π": {
        "code": "–¶–§–û",
        "regions": [
            "–ú–æ—Å–∫–≤–∞",
            "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ë–µ–ª–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ë—Ä—è–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–í–æ—Ä–æ–Ω–µ–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ò–≤–∞–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ö–∞–ª—É–∂—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ö–æ—Å—Ç—Ä–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ö—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–õ–∏–ø–µ—Ü–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–û—Ä–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–†—è–∑–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–°–º–æ–ª–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–¢–∞–º–±–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–¢–≤–µ—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–¢—É–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–Ø—Ä–æ—Å–ª–∞–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
        ]
    },
    "–°–µ–≤–µ—Ä–æ-–ó–∞–ø–∞–¥–Ω—ã–π": {
        "code": "–°–ó–§–û",
        "regions": [
            "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
            "–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–í–æ–ª–æ–≥–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞—Ä–µ–ª–∏—è",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–æ–º–∏",
            "–ú—É—Ä–º–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ù–µ–Ω–µ—Ü–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥",
            "–ù–æ–≤–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ü—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å"
        ]
    },
    "–Æ–∂–Ω—ã–π": {
        "code": "–Æ–§–û",
        "regions": [
            "–†–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ê—Å—Ç—Ä–∞—Ö–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–í–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–¥—ã–≥–µ—è",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö–∞–ª–º—ã–∫–∏—è",
            "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ö—Ä—ã–º",
            "–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å"
        ]
    },
    "–°–µ–≤–µ—Ä–æ-–ö–∞–≤–∫–∞–∑—Å–∫–∏–π": {
        "code": "–°–ö–§–û",
        "regions": [
            "–°—Ç–∞–≤—Ä–æ–ø–æ–ª—å—Å–∫–∏–π –∫—Ä–∞–π",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –î–∞–≥–µ—Å—Ç–∞–Ω",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ò–Ω–≥—É—à–µ—Ç–∏—è",
            "–ö–∞–±–∞—Ä–¥–∏–Ω–æ-–ë–∞–ª–∫–∞—Ä—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞",
            "–ö–∞—Ä–∞—á–∞–µ–≤–æ-–ß–µ—Ä–∫–µ—Å—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–µ–≤–µ—Ä–Ω–∞—è –û—Å–µ—Ç–∏—è ‚Äî –ê–ª–∞–Ω–∏—è",
            "–ß–µ—á–µ–Ω—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞"
        ]
    },
    "–ü—Ä–∏–≤–æ–ª–∂—Å–∫–∏–π": {
        "code": "–ü–§–û",
        "regions": [
            "–ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ö–∏—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–°–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–û—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ü–µ–Ω–∑–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ü–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π",
            "–°–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–£–ª—å—è–Ω–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–∞—Ä–∏–π –≠–ª",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ú–æ—Ä–¥–æ–≤–∏—è",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω",
            "–£–¥–º—É—Ä—Ç—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞",
            "–ß—É–≤–∞—à—Å–∫–∞—è –†–µ—Å–ø—É–±–ª–∏–∫–∞"
        ]
    },
    "–£—Ä–∞–ª—å—Å–∫–∏–π": {
        "code": "–£–§–û",
        "regions": [
            "–°–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ß–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ö—É—Ä–≥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–¢—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥ ‚Äî –Æ–≥—Ä–∞",
            "–Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥"
        ]
    },
    "–°–∏–±–∏—Ä—Å–∫–∏–π": {
        "code": "–°–§–û",
        "regions": [
            "–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ê–ª—Ç–∞–π—Å–∫–∏–π –∫—Ä–∞–π",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ê–ª—Ç–∞–π",
            "–ò—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ö–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π",
            "–û–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–¢–æ–º—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –¢—ã–≤–∞",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –•–∞–∫–∞—Å–∏—è"
        ]
    },
    "–î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω—ã–π": {
        "code": "–î–§–û",
        "regions": [
            "–•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π",
            "–ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π",
            "–ê–º—É—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ö–∞–º—á–∞—Ç—Å–∫–∏–π –∫—Ä–∞–π",
            "–ú–∞–≥–∞–¥–∞–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–°–∞—Ö–∞–ª–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –°–∞—Ö–∞ (–Ø–∫—É—Ç–∏—è)",
            "–ï–≤—Ä–µ–π—Å–∫–∞—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è –æ–±–ª–∞—Å—Ç—å",
            "–ß—É–∫–æ—Ç—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥",
            "–†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë—É—Ä—è—Ç–∏—è",
            "–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π –∫—Ä–∞–π"
        ]
    }
}


# –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å: —Ä–µ–≥–∏–æ–Ω -> —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥
REGION_TO_DISTRICT = {}
ALL_REGIONS = []
for district_name, district_data in FEDERAL_DISTRICTS.items():
    for region in district_data["regions"]:
        REGION_TO_DISTRICT[region.lower()] = district_name
        ALL_REGIONS.append(region)


# –°–ª–æ–≤–∞—Ä—å —Å–æ–∫—Ä–∞—â–µ–Ω–∏–π –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
REGION_ALIASES = {
    "–º–æ—Å–∫–≤–∞": ["–º—Å–∫", "moscow"],
    "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥": ["—Å–ø–±", "–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–ø–∏—Ç–µ—Ä", "—Å–∞–Ω–∫—Ç –ø–µ—Ç–µ—Ä–±—É—Ä–≥", "–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥"],
    "–º–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["–ø–æ–¥–º–æ—Å–∫–æ–≤—å–µ", "–º–æ", "–º–æ—Å–∫–æ–≤ –æ–±–ª"],
    "–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["–ª–æ", "–ª–µ–Ω–æ–±–ª–∞—Å—Ç—å"],
    "–Ω–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥", "–Ω–∏–∂–Ω–∏–π", "–Ω–Ω–æ–≤"],
    "—Ö–∞–Ω—Ç—ã-–º–∞–Ω—Å–∏–π—Å–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥ ‚Äî —é–≥—Ä–∞": ["—Ö–º–∞–æ", "—é–≥—Ä–∞", "—Ö–∞–Ω—Ç—ã-–º–∞–Ω—Å–∏–π—Å–∫"],
    "—è–º–∞–ª–æ-–Ω–µ–Ω–µ—Ü–∫–∏–π –∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥": ["—è–Ω–∞–æ", "—è–º–∞–ª"],
    "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π": ["–∫—É–±–∞–Ω—å", "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä"],
    "—Ä–µ—Å–ø—É–±–ª–∏–∫–∞ –∫—Ä—ã–º": ["–∫—Ä—ã–º"],
    "—Ä–µ—Å–ø—É–±–ª–∏–∫–∞ —Ç–∞—Ç–∞—Ä—Å—Ç–∞–Ω": ["—Ç–∞—Ç–∞—Ä—Å—Ç–∞–Ω", "–∫–∞–∑–∞–Ω—å"],
    "—Ä–µ—Å–ø—É–±–ª–∏–∫–∞ –±–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω": ["–±–∞—à–∫–æ—Ä—Ç–æ—Å—Ç–∞–Ω", "–±–∞—à–∫–∏—Ä–∏—è", "—É—Ñ–∞"],
    "—Å–≤–µ—Ä–¥–ª–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–µŒ∫–±—É—Ä–≥"],
    "—á–µ–ª—è–±–∏–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["—á–µ–ª—è–±–∏–Ω—Å–∫", "—á–µ–ª"],
    "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫", "–Ω–æ–≤–æ—Å–∏–±"],
    "–∫–µ–º–µ—Ä–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["–∫—É–∑–±–∞—Å—Å", "–∫–µ–º–µ—Ä–æ–≤–æ"],
    "—Ä–æ—Å—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["—Ä–æ—Å—Ç–æ–≤", "—Ä–æ—Å—Ç–æ–≤-–Ω–∞-–¥–æ–Ω—É"],
    "—Å–∞–º–∞—Ä—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["—Å–∞–º–∞—Ä–∞"],
    "–ø–µ—Ä–º—Å–∫–∏–π –∫—Ä–∞–π": ["–ø–µ—Ä–º—å"],
    "–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π –∫—Ä–∞–π": ["–∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫"],
    "—Ö–∞–±–∞—Ä–æ–≤—Å–∫–∏–π –∫—Ä–∞–π": ["—Ö–∞–±–∞—Ä–æ–≤—Å–∫"],
    "–ø—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π": ["–≤–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫", "–ø—Ä–∏–º–æ—Ä"],
    "–∏—Ä–∫—É—Ç—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["–∏—Ä–∫—É—Ç—Å–∫"],
    "–≤–æ–ª–≥–æ–≥—Ä–∞–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["–≤–æ–ª–≥–æ–≥—Ä–∞–¥"],
    "—Å–∞—Ä–∞—Ç–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["—Å–∞—Ä–∞—Ç–æ–≤"],
    "—Ç—é–º–µ–Ω—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["—Ç—é–º–µ–Ω—å"],
    "–æ—Ä–µ–Ω–±—É—Ä–≥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å": ["–æ—Ä–µ–Ω–±—É—Ä–≥"],
    "—Ä–µ—Å–ø—É–±–ª–∏–∫–∞ —Å–∞—Ö–∞ (—è–∫—É—Ç–∏—è)": ["—è–∫—É—Ç–∏—è", "—è–∫—É—Ç—Å–∫"],
}

# –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å: –∞–ª–∏–∞—Å -> –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
ALIAS_TO_REGION = {}
for official_name, aliases in REGION_ALIASES.items():
    for alias in aliases:
        ALIAS_TO_REGION[alias.lower()] = official_name


def normalize_region_name(region_input: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–∞ (lowercase, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã).

    Args:
        region_input: –í—Ö–æ–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞

    Returns:
        –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
    """
    # –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ lowercase
    normalized = re.sub(r'\s+', ' ', region_input.strip()).lower()
    # –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ "–æ–±–ª", "–≥" –∏ —Ç.–¥.
    normalized = re.sub(r'\b(–æ–±–ª|–≥|—Ä–µ—Å–ø|–∫—Ä–∞–π|–∞–≤—Ç|–æ–∫—Ä|–∞–æ)\b\.?', r'\1', normalized)
    return normalized


def find_region(region_input: str, threshold: float = 0.6) -> Optional[str]:
    """
    –ü–æ–∏—Å–∫ —Ä–µ–≥–∏–æ–Ω–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º fuzzy matching.

    Args:
        region_input: –í—Ö–æ–¥–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞
        threshold: –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ (0-1)

    Returns:
        –û—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
    """
    normalized_input = normalize_region_name(region_input)

    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (lowercase)
    for region in ALL_REGIONS:
        if normalize_region_name(region) == normalized_input:
            return region

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–ª–∏–∞—Å—ã
    if normalized_input in ALIAS_TO_REGION:
        official_name = ALIAS_TO_REGION[normalized_input]
        # –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞
        for region in ALL_REGIONS:
            if normalize_region_name(region) == official_name:
                return region

    # 3. Fuzzy matching –ø–æ –≤—Å–µ–º —Ä–µ–≥–∏–æ–Ω–∞–º
    all_regions_lower = [r.lower() for r in ALL_REGIONS]
    matches = get_close_matches(normalized_input, all_regions_lower, n=1, cutoff=threshold)

    if matches:
        # –ù–∞—Ö–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (—Å –∑–∞–≥–ª–∞–≤–Ω—ã–º–∏ –±—É–∫–≤–∞–º–∏)
        matched_lower = matches[0]
        for region in ALL_REGIONS:
            if region.lower() == matched_lower:
                return region

    return None


def parse_regions_input(regions_text: str) -> List[str]:
    """
    –ü–∞—Ä—Å–∏–Ω–≥ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é —Å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º.

    Args:
        regions_text: –¢–µ–∫—Å—Ç —Å —Ä–µ–≥–∏–æ–Ω–∞–º–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

    Returns:
        –°–ø–∏—Å–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã—Ö –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π —Ä–µ–≥–∏–æ–Ω–æ–≤
    """
    if not regions_text or not regions_text.strip():
        return [], []

    # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π
    region_inputs = [r.strip() for r in regions_text.split(',') if r.strip()]

    recognized_regions = []
    unrecognized = []

    for region_input in region_inputs:
        recognized = find_region(region_input)
        if recognized:
            recognized_regions.append(recognized)
        else:
            unrecognized.append(region_input)

    return recognized_regions, unrecognized


def get_regions_by_district(district_name: str) -> List[str]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞.

    Args:
        district_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞

    Returns:
        –°–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤
    """
    district_data = FEDERAL_DISTRICTS.get(district_name)
    if district_data:
        return district_data["regions"]
    return []


def get_district_by_region(region_name: str) -> Optional[str]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ä–µ–≥–∏–æ–Ω–∞.

    Args:
        region_name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞

    Returns:
        –ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞ –∏–ª–∏ None
    """
    return REGION_TO_DISTRICT.get(region_name.lower())


def get_all_federal_districts() -> List[Dict[str, any]]:
    """
    –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã—Ö –æ–∫—Ä—É–≥–æ–≤.

    Returns:
        –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –§–û
    """
    return [
        {
            "name": name,
            "code": data["code"],
            "regions_count": len(data["regions"])
        }
        for name, data in FEDERAL_DISTRICTS.items()
    ]


def format_regions_list(regions: List[str], max_display: int = 5) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.

    Args:
        regions: –°–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤
        max_display: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

    Returns:
        –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
    """
    if not regions:
        return "–ù–µ —É–∫–∞–∑–∞–Ω—ã"

    if len(regions) <= max_display:
        return ", ".join(regions)
    else:
        displayed = regions[:max_display]
        remaining = len(regions) - max_display
        return f"{', '.join(displayed)} –∏ –µ—â–µ {remaining}"


# ============================================
# –¢–ï–°–¢–´ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏)
# ============================================

if __name__ == "__main__":
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è regions.py\n")

    # –¢–µ—Å—Ç 1: –ü–æ–∏—Å–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤
    test_inputs = [
        "–º–æ—Å–∫–≤–∞",
        "–ú–°–ö",
        "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
        "—Å–ø–±",
        "–º–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª",
        "–ù–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥",
        "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä",
        "–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥",
        "Invalid Region"
    ]

    print("1. –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤:")
    for test_input in test_inputs:
        result = find_region(test_input)
        status = "‚úÖ" if result else "‚ùå"
        print(f"  {status} '{test_input}' ‚Üí {result}")

    # –¢–µ—Å—Ç 2: –ü–∞—Ä—Å–∏–Ω–≥ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤
    print("\n2. –¢–µ—Å—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤:")
    test_multi = "–º–æ—Å–∫–≤–∞, —Å–ø–±, –∫—Ä–∞—Å–Ω–æ–¥–∞—Ä, –Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥, Invalid"
    recognized, unrecognized = parse_regions_input(test_multi)
    print(f"  –í–≤–æ–¥: {test_multi}")
    print(f"  ‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ ({len(recognized)}): {recognized}")
    print(f"  ‚ùå –ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ ({len(unrecognized)}): {unrecognized}")

    # –¢–µ—Å—Ç 3: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–æ–≤ –§–û
    print("\n3. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–æ–≤ –§–û:")
    central_regions = get_regions_by_district("–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π")
    print(f"  –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –§–û: {len(central_regions)} —Ä–µ–≥–∏–æ–Ω–æ–≤")
    print(f"  –ü–µ—Ä–≤—ã–µ 5: {central_regions[:5]}")

    # –¢–µ—Å—Ç 4: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –§–û –ø–æ —Ä–µ–≥–∏–æ–Ω—É
    print("\n4. –¢–µ—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –§–û –ø–æ —Ä–µ–≥–∏–æ–Ω—É:")
    test_regions = ["–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π"]
    for region in test_regions:
        district = get_district_by_region(region)
        print(f"  {region} ‚Üí {district}")

    print("\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!")
