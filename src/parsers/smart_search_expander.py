"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–º–æ—â—å—é LLM.
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ–Ω–¥–µ—Ä–æ–≤.
"""

from typing import List, Dict, Any
import json


class SmartSearchExpander:
    """–†–∞—Å—à–∏—Ä—è–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –±–æ–ª–µ–µ —à–∏—Ä–æ–∫–æ–≥–æ –æ—Ö–≤–∞—Ç–∞."""

    def __init__(self, llm_adapter):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–∏—Ç–µ–ª—è –ø–æ–∏—Å–∫–∞.

        Args:
            llm_adapter: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LLM
        """
        self.llm = llm_adapter

    def expand_search_query(self, original_query: str, max_variants: int = 5) -> List[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã.

        Args:
            original_query: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ")
            max_variants: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

        Returns:
            –°–ø–∏—Å–æ–∫ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤–∫–ª—é—á–∞—è –æ—Ä–∏–≥–∏–Ω–∞–ª)
        """
        prompt = f"""–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–∫—É–ø–∫–∞–º –≤ –†–æ—Å—Å–∏–∏.

–ó–ê–î–ê–ß–ê: –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–µ–Ω–¥–µ—Ä–æ–≤ –Ω–∞ zakupki.gov.ru.

–û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –ó–ê–ü–†–û–°: "{original_query}"

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –í–∫–ª—é—á–∏ —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –±–ª–∏–∑–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã
2. –í–∫–ª—é—á–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥, –∫–æ—Ç–æ—Ä—ã–µ –≤—Ö–æ–¥—è—Ç –≤ —ç—Ç–æ –ø–æ–Ω—è—Ç–∏–µ
3. –í–∫–ª—é—á–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ç–µ–Ω–¥–µ—Ä–æ–≤
4. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é –≥–æ—Å–∑–∞–∫—É–ø–æ–∫
5. –í–µ—Ä–Ω–∏ {max_variants} –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

–ü–†–ò–ú–ï–†–´:
- –î–ª—è "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ": –≤–∏–¥–µ–æ–∫–∞—Ä—Ç—ã, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã, –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤, –ø–µ—Ä–∏—Ñ–µ—Ä–∏–π–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Å–∏—Å—Ç–µ–º–Ω—ã–µ –±–ª–æ–∫–∏
- –î–ª—è "–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ": –ª–∏—Ü–µ–Ω–∑–∏–∏ –Ω–∞ –ü–û, –∞–Ω—Ç–∏–≤–∏—Ä—É—Å–Ω–æ–µ –ü–û, –æ—Ñ–∏—Å–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ü–û

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{{
  "original": "–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å",
  "expanded": [
    "–≤–∞—Ä–∏–∞–Ω—Ç 1",
    "–≤–∞—Ä–∏–∞–Ω—Ç 2",
    "–≤–∞—Ä–∏–∞–Ω—Ç 3"
  ],
  "reasoning": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω—ã —ç—Ç–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã"
}}
"""

        try:
            response = self.llm.generate(system_prompt="–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–∫—É–ø–∫–∞–º –≤ –†–æ—Å—Å–∏–∏.", user_prompt=prompt)

            # –ü–∞—Ä—Å–∏–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            # –ò—â–µ–º JSON –≤ –æ—Ç–≤–µ—Ç–µ
            start_idx = response.find('{')
            end_idx = response.rfind('}') + 1

            if start_idx != -1 and end_idx > start_idx:
                json_str = response[start_idx:end_idx]
                result = json.loads(json_str)

                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
                queries = [original_query]  # –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª

                if 'expanded' in result and isinstance(result['expanded'], list):
                    queries.extend(result['expanded'][:max_variants - 1])

                print(f"\nüí° –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ '{original_query}':")
                print(f"   üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: {len(queries) - 1}")
                for i, q in enumerate(queries[1:], 1):
                    print(f"      {i}. {q}")

                if 'reasoning' in result:
                    print(f"   ü§î –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ: {result['reasoning']}")

                return queries

        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ LLM: {e}")

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –µ—Å–ª–∏ LLM –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
        return [original_query]

    def generate_okpd_categories(self, query: str) -> List[str]:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–¥—ã –û–ö–ü–î2 –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞.

        Args:
            query: –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å

        Returns:
            –°–ø–∏—Å–æ–∫ –∫–æ–¥–æ–≤ –û–ö–ü–î2
        """
        prompt = f"""–û–ø—Ä–µ–¥–µ–ª–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–¥—ã –û–ö–ü–î2 (–û–±—â–µ—Ä–æ—Å—Å–∏–π—Å–∫–∏–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–¥—É–∫—Ü–∏–∏) –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞: "{query}"

–í–µ—Ä–Ω–∏ 3-5 –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–æ–¥–æ–≤ –û–ö–ü–î2 –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
  "codes": [
    {{"code": "26.20.1", "name": "–ö–æ–º–ø—å—é—Ç–µ—Ä—ã –∏ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–π–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ"}},
    {{"code": "26.30.5", "name": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–µ"}}
  ]
}}
"""

        try:
            response = self.llm.generate(system_prompt="–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–∫—É–ø–∫–∞–º –≤ –†–æ—Å—Å–∏–∏.", user_prompt=prompt)

            start_idx = response.find('{')
            end_idx = response.rfind('}') + 1

            if start_idx != -1 and end_idx > start_idx:
                json_str = response[start_idx:end_idx]
                result = json.loads(json_str)

                if 'codes' in result:
                    return [item['code'] for item in result['codes']]

        except Exception as e:
            print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –û–ö–ü–î2: {e}")

        return []


class TenderDataExtractor:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ç–µ–Ω–¥–µ—Ä–µ —Å –ø–æ–º–æ—â—å—é LLM."""

    def __init__(self, llm_adapter):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.

        Args:
            llm_adapter: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LLM
        """
        self.llm = llm_adapter

    def extract_tender_details(self, tender_summary: str) -> Dict[str, Any]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–µ–Ω–¥–µ—Ä–∞.

        Args:
            tender_summary: –û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–Ω–¥–µ—Ä–∞ –∏–∑ RSS –∏–ª–∏ HTML

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        """
        prompt = f"""–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–Ω–¥–µ—Ä–∞ –∏ –∏–∑–≤–ª–µ–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–û–ü–ò–°–ê–ù–ò–ï –¢–ï–ù–î–ï–†–ê:
{tender_summary[:3000]}

–ó–ê–î–ê–ß–ê: –ò–∑–≤–ª–µ–∫–∏ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –≤–µ—Ä–Ω–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:

{{
  "tender_type": "–¢–∏–ø –∑–∞–∫—É–ø–∫–∏ (—Ç–æ–≤–∞—Ä—ã/—Ä–∞–±–æ—Ç—ã/—É—Å–ª—É–≥–∏)",
  "categories": ["–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è 2"],
  "region": "–†–µ–≥–∏–æ–Ω",
  "customer_type": "–¢–∏–ø –∑–∞–∫–∞–∑—á–∏–∫–∞ (—Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π/—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π/–º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π)",
  "submission_deadline": "–°—Ä–æ–∫ –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–æ–∫ (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)",
  "winner_determination_date": "–°—Ä–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)",
  "payment_terms": "–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)",
  "quantity_info": "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —Ç–æ–≤–∞—Ä–æ–≤ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)",
  "okpd_codes": ["–ö–æ–¥ –û–ö–ü–î2 –µ—Å–ª–∏ –µ—Å—Ç—å"]
}}

–í–ê–ñ–ù–û:
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–π null
- –î–ª—è categories —É–∫–∞–∂–∏ –≤—Å–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤/—É—Å–ª—É–≥
- region - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–≥–∏–æ–Ω–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞
- submission_deadline - —Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–µ–º–∞ –∑–∞—è–≤–æ–∫
- winner_determination_date - –¥–∞—Ç–∞ –ø–æ–¥–≤–µ–¥–µ–Ω–∏—è –∏—Ç–æ–≥–æ–≤, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
- payment_terms - –ª—é–±–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤–∞–Ω—Å, —Ä–∞—Å—Å—Ä–æ—á–∫–µ, –ø–æ—Ä—è–¥–∫–µ –æ–ø–ª–∞—Ç—ã
"""

        try:
            response = self.llm.generate(system_prompt="–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–∞–∫—É–ø–∫–∞–º –≤ –†–æ—Å—Å–∏–∏.", user_prompt=prompt)

            start_idx = response.find('{')
            end_idx = response.rfind('}') + 1

            if start_idx != -1 and end_idx > start_idx:
                json_str = response[start_idx:end_idx]
                result = json.loads(json_str)
                return result

        except Exception as e:
            print(f"   ‚ö†Ô∏è  –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ LLM: {e}")

        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        return {
            "tender_type": None,
            "categories": [],
            "region": None,
            "customer_type": None,
            "submission_deadline": None,
            "winner_determination_date": None,
            "payment_terms": None,
            "quantity_info": None,
            "okpd_codes": []
        }


def main():
    """–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è."""
    import sys
    from pathlib import Path
    sys.path.insert(0, str(Path(__file__).parent.parent))

    from analyzers.tender_analyzer import TenderAnalyzer
    from utils.config_loader import ConfigLoader

    print("\n" + "="*70)
    print("  –¢–ï–°–¢ –£–ú–ù–û–ì–û –†–ê–°–®–ò–†–ï–ù–ò–Ø –ü–û–ò–°–ö–ê")
    print("="*70 + "\n")

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    config = ConfigLoader()
    llm_config = config.get_llm_config()

    # –°–æ–∑–¥–∞–µ–º TenderAnalyzer
    tender_analyzer = TenderAnalyzer(
        api_key=llm_config['api_key'],
        provider=llm_config['provider'],
        model_fast=llm_config.get('model_fast')
    )

    # –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—à–∏—Ä–∏—Ç–µ–ª—å
    expander = SmartSearchExpander(tender_analyzer.llm)

    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
    test_queries = [
        "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
        "–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ",
        "–∫–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–∏–µ —Ç–æ–≤–∞—Ä—ã"
    ]

    for query in test_queries:
        print(f"\n{'‚îÄ'*70}")
        print(f"–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å: '{query}'")
        print(f"{'‚îÄ'*70}")

        expanded = expander.expand_search_query(query, max_variants=5)

        print(f"\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è ({len(expanded)} –∑–∞–ø—Ä–æ—Å–æ–≤):")
        for i, q in enumerate(expanded, 1):
            print(f"   {i}. {q}")

    print("\n" + "="*70)


if __name__ == "__main__":
    main()
