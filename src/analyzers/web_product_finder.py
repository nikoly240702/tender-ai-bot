"""
–ú–æ–¥—É–ª—å –¥–ª—è –≤–µ–±-–ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
–†–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–≤—è–∑–∫–µ —Å ProductSearcher –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.
"""

import json
from typing import Dict, Any, List, Optional


class WebProductFinder:
    """–ö–ª–∞—Å—Å –¥–ª—è –≤–µ–±-–ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏."""

    def __init__(self, llm_adapter):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–±-–ø–æ–∏—Å–∫–æ–≤–∏–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤.

        Args:
            llm_adapter: –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LLM
        """
        self.llm = llm_adapter

    def build_search_query(self, product: Dict[str, Any]) -> str:
        """
        –°—Ç—Ä–æ–∏—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —Ç–æ–≤–∞—Ä–∞.

        Args:
            product: –°–ª–æ–≤–∞—Ä—å —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏ —Ç–æ–≤–∞—Ä–∞

        Returns:
            –°—Ç—Ä–æ–∫–∞ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        """
        # –ë–∞–∑–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
        query_parts = [product.get('name', '')]

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
        specs = product.get('specifications', {})

        # –î–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ - —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        key_specs = []

        # –î–ª—è –≤–∏–¥–µ–æ–∫–∞—Ä—Ç
        if '–ø–∞–º—è—Ç—å' in str(specs).lower() or 'memory' in str(specs).lower():
            for key, value in specs.items():
                if any(word in key.lower() for word in ['–ø–∞–º—è—Ç—å', 'memory', '–æ–±—ä–µ–º']):
                    key_specs.append(str(value))
                    break

        # –î–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤
        if '—á–∞—Å—Ç–æ—Ç–∞' in str(specs).lower() or 'frequency' in str(specs).lower():
            for key, value in specs.items():
                if '—á–∞—Å—Ç–æ—Ç–∞' in key.lower() or 'frequency' in key.lower():
                    key_specs.append(str(value))
                    break

        # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–µ 2-3 –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
        if key_specs:
            query_parts.extend(key_specs[:3])

        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–≤–æ "–∫—É–ø–∏—Ç—å" –¥–ª—è –±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        query_parts.append("–∫—É–ø–∏—Ç—å")

        return ' '.join(query_parts)

    def search_product_offers(
        self,
        product: Dict[str, Any],
        max_results: int = 5
    ) -> List[Dict[str, Any]]:
        """
        –ò—â–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.

        Args:
            product: –°–ª–æ–≤–∞—Ä—å —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏ —Ç–æ–≤–∞—Ä–∞
            max_results: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

        Returns:
            –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å —Å—Å—ã–ª–∫–∞–º–∏ –∏ —Ü–µ–Ω–∞–º–∏
        """
        # –°—Ç—Ä–æ–∏–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        search_query = self.build_search_query(product)

        print(f"  üîç –ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: {search_query}")

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º LLM –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        system_prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–æ–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –¥–ª—è B2B –∑–∞–∫—É–ø–æ–∫."""

        user_prompt = f"""# –ó–ê–î–ê–ß–ê
–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.

# –¢–û–í–ê–†
–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: {product.get('name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}
–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
{json.dumps(product.get('specifications', {}), ensure_ascii=False, indent=2)}

# –¢–†–ï–ë–û–í–ê–ù–ò–Ø
1. –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –í–∫–ª—é—á–∏ –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
3. –î–æ–±–∞–≤—å —Å–ª–æ–≤–∞ –¥–ª—è B2B –ø–æ–∏—Å–∫–∞: "–æ–ø—Ç–æ–º", "–¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü"
4. –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —É–∑–∫–∏–º

# –†–ï–ó–£–õ–¨–¢–ê–¢
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.
"""

        try:
            optimized_query = self.llm.generate(system_prompt, user_prompt).strip()
            print(f"  üéØ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å: {optimized_query}")

            # –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –≤–µ–±-–ø–æ–∏—Å–∫
            # –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ - –∑–∞–≥–ª—É—à–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –±—É–¥—É—â–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

            # TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WebSearch API –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
            # –í—Ä–µ–º–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏

            return [{
                'search_query': optimized_query,
                'status': 'pending_implementation',
                'message': '–í–µ–±-–ø–æ–∏—Å–∫ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö'
            }]

        except Exception as e:
            print(f"  ‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: {e}")
            return []

    def analyze_search_results(
        self,
        product: Dict[str, Any],
        search_results: List[Dict[str, Any]]
    ) -> Dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.

        Args:
            product: –ò—Å—Ö–æ–¥–Ω—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–∞
            search_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–±-–ø–æ–∏—Å–∫–∞

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –æ—Ç–æ–±—Ä–∞–Ω–Ω—ã–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –∏ –∞–Ω–∞–ª–∏–∑–æ–º
        """
        if not search_results:
            return {
                'offers_found': False,
                'message': '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'
            }

        system_prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–∫—É–ø–æ–∫."""

        user_prompt = f"""# –ó–ê–î–ê–ß–ê
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.

# –¢–†–ï–ë–£–ï–ú–´–ï –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò
{json.dumps(product.get('specifications', {}), ensure_ascii=False, indent=2)}

# –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê
{json.dumps(search_results, ensure_ascii=False, indent=2)}

# –†–ï–ó–£–õ–¨–¢–ê–¢
–í–µ—Ä–Ω–∏ JSON:
{{
    "matching_offers": [
        {{
            "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
            "url": "–°—Å—ã–ª–∫–∞",
            "price": —Ü–µ–Ω–∞_–≤_—Ä—É–±–ª—è—Ö,
            "match_score": 0-100,
            "pros": ["–ü–ª—é—Å 1", "–ü–ª—é—Å 2"],
            "cons": ["–ú–∏–Ω—É—Å 1", "–ú–∏–Ω—É—Å 2"],
            "specifications_match": {{
                "–ø–∞—Ä–∞–º–µ—Ç—Ä": "—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ"
            }}
        }}
    ],
    "best_offer": {{
        "title": "...",
        "url": "...",
        "price": ...,
        "reasoning": "–ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ"
    }},
    "price_range": {{
        "min": –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è_—Ü–µ–Ω–∞,
        "max": –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è_—Ü–µ–Ω–∞,
        "average": —Å—Ä–µ–¥–Ω—è—è_—Ü–µ–Ω–∞
    }}
}}

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –±–µ–∑ markdown.
"""

        try:
            response = self.llm.generate(system_prompt, user_prompt)

            # –û—á–∏—Å—Ç–∫–∞ –æ—Ç markdown
            response = response.strip()
            if response.startswith('```json'):
                response = response[7:]
            if response.startswith('```'):
                response = response[3:]
            if response.endswith('```'):
                response = response[:-3]
            response = response.strip()

            analysis = json.loads(response)
            return {
                'offers_found': True,
                'analysis': analysis
            }

        except Exception as e:
            print(f"  ‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: {e}")
            return {
                'offers_found': False,
                'message': f'–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}'
            }

    def find_product_links(
        self,
        product: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–∞: –∑–∞–ø—Ä–æ—Å -> –ø–æ–∏—Å–∫ -> –∞–Ω–∞–ª–∏–∑.

        Args:
            product: –°–ª–æ–≤–∞—Ä—å —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏ —Ç–æ–≤–∞—Ä–∞

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞ –∏ —Å—Å—ã–ª–∫–∞–º–∏
        """
        print(f"\nüîé –ü–æ–∏—Å–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è: {product.get('name', '—Ç–æ–≤–∞—Ä')}")

        # –≠—Ç–∞–ø 1: –ü–æ–∏—Å–∫
        search_results = self.search_product_offers(product)

        if not search_results:
            return {
                'product_name': product.get('name'),
                'links_found': False,
                'message': '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ'
            }

        # –≠—Ç–∞–ø 2: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        analysis = self.analyze_search_results(product, search_results)

        return {
            'product_name': product.get('name'),
            'links_found': analysis.get('offers_found', False),
            'search_results': search_results,
            'analysis': analysis.get('analysis', {}),
            'message': analysis.get('message', '')
        }


if __name__ == "__main__":
    print("–ú–æ–¥—É–ª—å –≤–µ–±-–ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!")
